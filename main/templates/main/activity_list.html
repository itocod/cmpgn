{% extends 'main/face.html' %}

{% load custom_filters %}
{% load static %}  
{% block content %}
    <!-- Include FontAwesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-*********" crossorigin="anonymous" />

<style>
/* Base Styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    color: #333;
    padding: 0;
    margin: 0;
    background-color: #fafafa;
    transition: background-color 0.3s ease, color 0.3s ease;
}

/* Dark Mode */
body.dark-mode {
    background-color: #121212;
    color: #e0e0e0;
}

body.dark-mode .activity-item {
    background-color: #1e1e1e;
    border-color: #333;
}

/* Activity List Container */
.activity-list {
    list-style-type: none;
    padding: 0;
    margin: 0;
}

/* Activity Item */
.activity-item {
    background-color: #fff;
    margin-bottom: 24px;
    border-radius: 8px;
    overflow: hidden;
    position: relative;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

@media (min-width: 768px) {
    .activity-item {
        border-radius: 12px;
        box-shadow: 0 2px 16px rgba(0, 0, 0, 0.08);
        max-width: 614px;
        margin-left: auto;
        margin-right: auto;
    }
}

.activity-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
}

/* Header Section */
.activity-header {
    display: flex;
    align-items: center;
    padding: 12px 16px;
     position: relative; /* Add this to contain the absolute positioned menu */
}

.profile-pic {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    overflow: hidden;
    margin-right: 12px;
    flex-shrink: 0;
}

.profile-pic img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: opacity 0.3s ease;
}

.profile-pic img.lazy {
    opacity: 0;
}

.profile-pic img.loaded {
    opacity: 1;
}

.user-info {
    flex-grow: 1;
     margin-right: 40px; /* Add space for the menu */
}

.username {
    font-weight: 600;
    font-size: 14px;
    color: #262626;
    display: flex;
    align-items: center;
}

body.dark-mode .username {
    color: #f5f5f5;
}

.verified-status {
    font-size: 12px;
    color: #4caf50;
    margin-left: 4px;
}

.verified-icon {
    font-size: 14px;
    margin-left: 4px;
}

.activity-timestamp {
    font-size: 12px;
    color: #707070; /* Improved contrast */
    margin-top: 2px;
}

body.dark-mode .activity-timestamp {
    color: #a0a0a0;
}

/* Content Section */
.activity-content {
    padding: 0 16px 12px;
    font-size: 14px;
    line-height: 1.5;
}

.see-more-text {
    color: #0095f6;
    cursor: pointer;
    font-weight: 500;
    transition: opacity 0.2s ease;
}

.see-more-text:hover {
    opacity: 0.8;
}

/* Media Section - Dominant Design */
.file-container {
    width: 100%;
    margin: 0;
    padding: 0;
    position: relative;
    background-color: #f0f0f0;
}

body.dark-mode .file-container {
    background-color: #2a2a2a;
}

.activity-media {
    width: 100%;
    max-height: 800px;
    object-fit: contain;
    display: block;
    background-color: #000;
    transition: opacity 0.3s ease;
}

.activity-media.lazy {
    opacity: 0;
}

.activity-media.loaded {
    opacity: 1;
}

/* Video Player Styling */
video.activity-media {
    background-color: #000;
}

/* Loading Spinner */
.loading-spinner {
    display: none;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: #0095f6;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: translate(-50%, -50%) rotate(360deg); }
}

/* Interactions Section */
.activity-interactions {
    padding: 8px 16px 12px;
    border-top: 1px solid #efefef;
    position: relative;
}

body.dark-mode .activity-interactions {
    border-top-color: #333;
}

.interaction-icons {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.icon {
    margin-right: 16px;
    font-size: 24px;
    cursor: pointer;
    color: #262626;
    transition: transform 0.2s ease, color 0.2s ease;
}

body.dark-mode .icon {
    color: #f5f5f5;
}

.icon:hover {
    transform: scale(1.1);
}

.icon.loved {
    color: #ed4956;
}

.icon.comment:hover {
    color: #0095f6;
}

.love-count {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 4px;
}

.view-details-link {
    display: inline-block;
    color: #707070; /* Improved contrast */
    font-size: 12px;
    text-decoration: none;
    margin-top: 4px;
    transition: color 0.2s ease;
}

.view-details-link:hover {
    color: #0095f6;
}

body.dark-mode .view-details-link {
    color: #a0a0a0;
}

body.dark-mode .view-details-link:hover {
    color: #4db5f9;
}

/* Mobile Full Width */
@media (max-width: 767px) {
    .activity-item {
        border-radius: 0;
        margin-bottom: 16px;
        border-bottom: 1px solid #efefef;
    }
    
    body.dark-mode .activity-item {
        border-bottom-color: #333;
    }
    
    .file-container {
        max-height: 100vh;
    }
}

/* Header Styles */
.cc-header {
    text-align: center;
    padding: 16px;
    margin-bottom: 16px;
}

.activity-title {
    font-size: 18px;
    font-weight: 600;
    color: #262626;
    margin-bottom: 8px;
}

body.dark-mode .activity-title {
    color: #f5f5f5;
}

.campaign-link {
    color: #0095f6;
    text-decoration: none;
    transition: opacity 0.2s ease;
}

.campaign-link:hover {
    opacity: 0.8;
}

.activity-count {
    font-size: 14px;
    color: #707070; /* Improved contrast */
}

body.dark-mode .activity-count {
    color: #a0a0a0;
}

/* Create Activity Button */
.create-activity-link {
    display: block;
    background-color: #0095f6;
    color: white;
    text-align: center;
    padding: 12px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    margin: 16px auto;
    max-width: 614px;
    transition: background-color 0.2s ease, transform 0.2s ease;
}

.create-activity-link:hover {
    background-color: #0080e0;
    transform: translateY(-1px);
}

/* No Activities Message */
.no-suggested-users {
    text-align: center;
    padding: 24px;
    color: #707070; /* Improved contrast */
    font-size: 14px;
}

body.dark-mode .no-suggested-users {
    color: #a0a0a0;
}

/* Content Toggle */
.hidden-content {
    display: none;
}

/* Heart Animation */
@keyframes heartScale {
    0% { transform: scale(1); }
    25% { transform: scale(1.2); }
    50% { transform: scale(0.9); }
    100% { transform: scale(1); }
}

.heart-animation {
    animation: heartScale 0.5s ease;
}

/* Back to Top Button */
.back-to-top {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 50px;
    height: 50px;
    background-color: #0095f6;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    cursor: pointer;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    z-index: 1000;
}

.back-to-top.visible {
    opacity: 1;
    visibility: visible;
}

.back-to-top:hover {
    background-color: #0080e0;
    transform: translateY(-3px);
}

/* Skeleton Loading */
.skeleton {
    background-color: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
    position: relative;
}

body.dark-mode .skeleton {
    background-color: #2a2a2a;
}

.skeleton::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, 
        rgba(255,255,255,0) 0%, 
        rgba(255,255,255,0.2) 50%, 
        rgba(255,255,255,0) 100%);
    animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}


/* Three dots menu */
.activity-menu {
    position: absolute;
    right: 16px;
    top: 12px;
    cursor: pointer;
    padding: 8px;
    z-index: 1; /* Ensure it's above other elements */
}

.activity-menu-dots {
    font-size: 16px;
    color: #262626;
    font-weight: bold;
    display: block;
    line-height: 1;
}

body.dark-mode .activity-menu-dots {
    color: #f5f5f5;
}

/* Menu popup */
.menu-popup {
    position: absolute;
    right: 0;
    top: 100%;
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    padding: 8px 0;
    min-width: 160px;
    z-index: 100;
    display: none;
}
body.dark-mode .menu-popup {
    background-color: #1e1e1e;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
}

.menu-popup.show {
    display: block;
}

.menu-item {
    padding: 8px 16px;
    font-size: 14px;
    color: #262626;
    text-decoration: none;
    display: block;
    white-space: nowrap;
}

.menu-item:hover {
    background-color: #f8f8f8;
}

body.dark-mode .menu-item {
    color: #f5f5f5;
}

body.dark-mode .menu-item:hover {
    background-color: #333;
}


    /* Comment Section Styles */
    .comment-section {
        margin-top: 12px;
        border-top: 1px solid #efefef;
        padding-top: 12px;
    }
    
    body.dark-mode .comment-section {
        border-top-color: #333;
    }
    
    .view-comments-link {
        color: #707070;
        font-size: 14px;
        text-decoration: none;
        display: block;
        margin-bottom: 8px;
        transition: color 0.2s ease;
    }
    
    .view-comments-link:hover {
        color: #0095f6;
    }
    
    body.dark-mode .view-comments-link {
        color: #a0a0a0;
    }
    
    /* Comment Form Styles */
    .comment-form-container {
        margin: 12px 0;
    }
    
    .activity-comment-form {
        display: flex;
        align-items: center;
    }
    
    .comment-textarea {
        flex-grow: 1;
        border: 1px solid #dbdbdb;
        border-radius: 20px;
        padding: 10px 16px;
        font-size: 14px;
        resize: none;
        height: 40px;
        transition: all 0.2s ease;
        background-color: #fafafa;
    }
    
    .comment-textarea:focus {
        outline: none;
        border-color: #0095f6;
        background-color: #fff;
        height: 60px;
    }
    
    body.dark-mode .comment-textarea {
        background-color: #2a2a2a;
        border-color: #444;
        color: #e0e0e0;
    }
    
</style>

<script type="text/javascript">
    // Function to handle loving an activity
    function loveActivity(activityId) {
        const loveIcon = document.querySelector(`.love-icon[data-activity-id="${activityId}"]`);
        const loveCount = document.getElementById(`love-count-${activityId}`);
        const spinner = document.createElement('div');
        spinner.className = 'loading-spinner';
        loveIcon.parentNode.appendChild(spinner);
        loveIcon.style.display = 'none';
        
        // Toggle loved state
        const isLoved = loveIcon.classList.contains('loved');
        if (!isLoved) {
            loveIcon.classList.add('loved');
            loveIcon.classList.add('heart-animation');
        }
        
        // Send AJAX request
        fetch(`/love_activity/${activityId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({})
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            if (data.love_count !== undefined) {
                loveCount.textContent = data.love_count + ' likes';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Revert UI if error
            if (!isLoved) {
                loveIcon.classList.remove('loved');
            }
            // Show error to user
            alert('Failed to update like. Please try again.');
        })
        .finally(() => {
            spinner.remove();
            loveIcon.style.display = 'block';
            setTimeout(() => {
                loveIcon.classList.remove('heart-animation');
            }, 500);
        });
    }

    // Function to toggle content visibility
    function toggleContent(activityId) {
        const shortContent = document.getElementById(`activity-content-${activityId}-short`);
        const fullContent = document.getElementById(`activity-content-${activityId}-full`);
        
        if (shortContent.style.display === 'none') {
            shortContent.style.display = 'block';
            fullContent.style.display = 'none';
        } else {
            shortContent.style.display = 'none';
            fullContent.style.display = 'block';
        }
    }

    // Back to Top Button
    document.addEventListener('DOMContentLoaded', function() {
        const backToTopButton = document.createElement('div');
        backToTopButton.className = 'back-to-top';
        backToTopButton.innerHTML = '<i class="fas fa-arrow-up"></i>';
        backToTopButton.onclick = function() {
            window.scrollTo({top: 0, behavior: 'smooth'});
        };
        document.body.appendChild(backToTopButton);
        
        window.addEventListener('scroll', function() {
            if (window.pageYOffset > 300) {
                backToTopButton.classList.add('visible');
            } else {
                backToTopButton.classList.remove('visible');
            }
        });

        // Lazy load images
        const lazyLoadImages = function() {
            const lazyImages = [].slice.call(document.querySelectorAll('img.lazy, video.lazy'));
            
            if ('IntersectionObserver' in window) {
                let lazyImageObserver = new IntersectionObserver(function(entries, observer) {
                    entries.forEach(function(entry) {
                        if (entry.isIntersecting) {
                            let lazyImage = entry.target;
                            lazyImage.src = lazyImage.dataset.src;
                            lazyImage.classList.remove('lazy');
                            lazyImage.classList.add('loaded');
                            lazyImageObserver.unobserve(lazyImage);
                        }
                    });
                });

                lazyImages.forEach(function(lazyImage) {
                    lazyImageObserver.observe(lazyImage);
                });
            } else {
                // Fallback for browsers without IntersectionObserver
                lazyImages.forEach(function(lazyImage) {
                    lazyImage.src = lazyImage.dataset.src;
                    lazyImage.classList.remove('lazy');
                    lazyImage.classList.add('loaded');
                });
            }
        };

        // Initialize lazy loading
        lazyLoadImages();
    });
</script>



<script type="text/javascript">
    // Add this to your existing JavaScript
    
    // Function to toggle menu popup
    function toggleMenu(menuId) {
        const menu = document.getElementById(menuId);
        const allMenus = document.querySelectorAll('.menu-popup');
        
        // Close all other open menus first
        allMenus.forEach(m => {
            if (m.id !== menuId && m.classList.contains('show')) {
                m.classList.remove('show');
            }
        });
        
        // Toggle current menu
        menu.classList.toggle('show');
    }
    
    // Close menu when clicking outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.activity-menu') && !event.target.closest('.menu-popup')) {
            document.querySelectorAll('.menu-popup.show').forEach(menu => {
                menu.classList.remove('show');
            });
        }
    });
</script>
{% if user == campaign.user.user %}
    <a href="{% url 'create_activity' campaign_id=campaign.id %}" class="create-activity-link">Create Activity</a>
{% endif %}

<div class="cc-header">
    <h2 class="activity-title">
        Activities for "<a href="{% url 'view_campaign' campaign_id=campaign.pk %}" class="campaign-link">{{ campaign.title }}</a>"
    </h2>
    <p class="activity-count">Total Activities: {{ activity_count }}</p>
</div>

{% if activities %}
    <ul class="activity-list">
        {% for activity in activities %}
            <li class="activity-item">
                <div class="activity-header">
                    <a href="{% url 'profile_view' username=campaign.user.user.username %}">
                        <div class="profile-pic">
                            <img 
                                data-src="{{ campaign.user.image.url }}" 
                                src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" 
                                class="lazy" 
                                alt="{{ campaign.user.user.username }}"
                                onerror="this.src='{% static 'images/default-profile.png' %}'">
                        </div>
                    </a>
                    <div class="user-info">
                        <div class="username">
                            {{ campaign.user.user.username }}
                            {% if campaign.user.profile_verified %}
                                <span class="verified-status">verified <i class="fas fa-check-circle verified-icon"></i></span>
                            {% endif %}
                        </div>
                        <div class="activity-timestamp">
                            {{ activity.timestamp|timesince }} ago
                        </div>
                    </div>
                </div>


<!-- Add this inside each activity-item, right after the activity-header closing div -->
<div class="activity-menu" onclick="toggleMenu('menu-{{ activity.id }}')">
    <span class="activity-menu-dots">⋯</span>
    <div class="menu-popup" id="menu-{{ activity.id }}">
        <a href="{% url 'activity_detail' activity_id=activity.id %}" class="menu-item">
            <i class="fas fa-info-circle" style="margin-right: 8px;"></i> View Activity Details
        </a>
        <!-- You can add more menu items here if needed -->
    </div>
</div>
                <div class="activity-content">
                    {% if activity.content.split|length > 20 %}
                        <div id="activity-content-{{ activity.id }}-short">
                            {{ activity.content|truncatewords:20|safe }}
                            <span class="see-more-text" onclick="toggleContent('{{ activity.id }}')">See More</span>
                        </div>
                        <div id="activity-content-{{ activity.id }}-full" class="hidden-content">
                            {{ activity.content|safe }}
                            <span class="see-more-text" onclick="toggleContent('{{ activity.id }}')">See Less</span>
                        </div>
                    {% else %}
                        {{ activity.content|safe }}
                    {% endif %}
                </div>

                <div class="file-container">
                    {% if activity.file %}
                        {% if activity.file.name|lower|slice:'-4:' == '.mp4' %}
                            <video 
                                data-src="{{ activity.file.url }}" 
                                class="activity-media lazy" 
                                controls
                                poster="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==">
                                Your browser does not support the video tag.
                            </video>
                        {% elif activity.file.name|lower|slice:'-4:' in image_extensions %}
                            <img 
                                data-src="{{ activity.file.url }}" 
                                src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" 
                                alt="Activity image" 
                                class="activity-media lazy"
                                onerror="this.src='{% static 'images/default-image.png' %}'">
                        {% endif %}
                    {% endif %}
                </div>

                <div class="activity-interactions">
                    <div class="interaction-icons">
                        <i class="far fa-heart icon love-icon {% if user in activity.loves.all %}loved{% endif %}" 
                           data-activity-id="{{ activity.id }}" 
                           onclick="loveActivity('{{ activity.id }}')"></i>
                        
                                    <i class="far fa-comment icon comment" onclick="toggleCommentSection('{{ activity.id }}'); event.stopPropagation();"></i>
                        </a>
                    </div>
                    <div class="love-count" id="love-count-{{ activity.id }}">
                        {{ activity.loves.count|format_count }} likes
                    </div>
                    <!-- In your activity-interactions div, add this after the love count -->

                    
             <!-- Add this inside your activity-item div, after the activity-interactions section -->
<div class="comment-section" id="comment-section-{{ activity.id }}" style="display: none;">
    <!-- Comment form -->
    <div class="comment-form-container">
        <form class="activity-comment-form" data-activity-id="{{ activity.id }}">
            {% csrf_token %}
            <textarea class="comment-textarea" placeholder="Add a comment..." required></textarea>
            <button type="submit" class="comment-submit-btn" style="margin-left: 8px; background: none; border: none; cursor: pointer;">
                <i class="fas fa-paper-plane" style="color: #0095f6; font-size: 20px;"></i>
            </button>
        </form>
    </div>
    
    <!-- Comments list -->
    <div class="comments-list" id="comments-list-{{ activity.id }}">
        <!-- Comments will be loaded here via AJAX -->
    </div>
    
    <!-- View all comments link -->
    {% if activity.comment_count > 2 %}
    <a href="#" class="view-all-comments" data-activity-id="{{ activity.id }}" style="display: none;">
        View all {{ activity.comment_count }} comments
    </a>
    {% endif %}
</div>
                </div>
            </li>
        {% endfor %}
    </ul>
{% else %}
    <div class="no-suggested-users">
        No activities yet. Check back later!
    </div>
{% endif %}



<script type="text/javascript">
// ==============================================
// COMMENT SYSTEM FUNCTIONS
// ==============================================

// --------------------------
// Comment Section Management
// --------------------------
function toggleCommentSection(activityId) {
    const commentSection = document.getElementById(`comment-section-${activityId}`);
    if (!commentSection) {
        console.error(`Comment section not found for activity ${activityId}`);
        return;
    }
    
    const isHidden = commentSection.style.display === 'none' || !commentSection.style.display;
    commentSection.style.display = isHidden ? 'block' : 'none';
    
    if (isHidden) {
        const commentsList = document.getElementById(`comments-list-${activityId}`);
        if (commentsList && commentsList.children.length === 0) {
            loadComments(activityId);
        }
    }
}

// ------------------
// Comment Loading
// ------------------
function loadComments(activityId, loadAll = false) {
    const commentsList = document.getElementById(`comments-list-${activityId}`);
    const viewAllLink = document.querySelector(`.view-all-comments[data-activity-id="${activityId}"]`);
    
    if (!commentsList) return;
    
    commentsList.innerHTML = '<div style="padding: 16px; text-align: center; color: #8e8e8e;">Loading comments...</div>';
    
    fetch(`/get_activity_comments/${activityId}/?all=${loadAll}`, {
        method: 'GET',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.comments?.length > 0) {
            renderComments(activityId, data.comments);
            if (viewAllLink) {
                viewAllLink.style.display = (data.total_comments > 2 && !loadAll) ? 'block' : 'none';
                viewAllLink.textContent = `View all ${data.total_comments} comments`;
            }
        } else {
            commentsList.innerHTML = '<div style="padding: 16px; text-align: center; color: #8e8e8e;">No comments yet. Be the first to comment!</div>';
            if (viewAllLink) viewAllLink.style.display = 'none';
        }
    })
    .catch(error => {
        console.error('Error loading comments:', error);
        commentsList.innerHTML = '<div style="padding: 16px; text-align: center; color: #ff0000;">Failed to load comments. Please try again.</div>';
    });
}

// ------------------
// Comment Rendering
// ------------------
function renderComments(activityId, comments) {
    const commentsList = document.getElementById(`comments-list-${activityId}`);
    if (!commentsList) return;
    
    commentsList.innerHTML = '';
    comments.forEach(comment => {
        const commentElement = document.createElement('div');
        commentElement.className = 'comment-item';
        commentElement.innerHTML = `
            <div class="comment-user-pic">
                <img src="${comment.user_image}" alt="${comment.username}" onerror="this.src='{% static 'images/default-profile.png' %}'">
            </div>
            <div class="comment-content">
                <div>
                    <span class="comment-username">${comment.username}</span>
                    <span class="comment-text">${comment.content}</span>
                </div>
                <div class="comment-meta">
                    <span class="comment-timestamp">${comment.timestamp}</span>
                    <button class="comment-reply-btn" data-comment-id="${comment.id}">Reply</button>
                    <button class="comment-like-btn ${comment.liked ? 'liked' : ''}" data-comment-id="${comment.id}">
                        <i class="far fa-heart"></i> ${comment.like_count}
                    </button>
                </div>
                <!-- Reply form (hidden by default) -->
                <div class="reply-form-container" id="reply-form-${comment.id}" style="display: none; margin-top: 10px;">
                    <form class="comment-reply-form" data-comment-id="${comment.id}">
                        {% csrf_token %}
                        <textarea class="reply-textarea" placeholder="Write a reply..." required style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;"></textarea>
                        <div style="margin-top: 5px;">
                            <button type="submit" class="reply-submit-btn" style="background: #0095f6; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                                Post Reply
                            </button>
                            <button type="button" class="cancel-reply-btn" data-comment-id="${comment.id}" style="background: #eee; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 5px;">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
                <!-- Replies container -->
                <div class="replies-list" id="replies-list-${comment.id}" style="margin-left: 20px; border-left: 2px solid #eee; padding-left: 10px;"></div>
            </div>
        `;
        commentsList.appendChild(commentElement);
        
        // Load replies for this comment if they exist
        if (comment.reply_count > 0) {
            loadReplies(comment.id);
        }
    });
    
    setupCommentEventListeners(activityId);
}

function setupCommentEventListeners(activityId) {
    // Like buttons
    document.querySelectorAll(`#comments-list-${activityId} .comment-like-btn`).forEach(btn => {
        btn.addEventListener('click', function() {
            const commentId = this.getAttribute('data-comment-id');
            likeComment(commentId, this);
        });
    });
    
    // Reply buttons
    document.querySelectorAll(`#comments-list-${activityId} .comment-reply-btn`).forEach(btn => {
        btn.addEventListener('click', function() {
            const commentId = this.getAttribute('data-comment-id');
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
            if (replyForm.style.display === 'block') {
                replyForm.querySelector('.reply-textarea').focus();
            }
        });
    });
    
    // Cancel reply buttons
    document.querySelectorAll(`#comments-list-${activityId} .cancel-reply-btn`).forEach(btn => {
        btn.addEventListener('click', function() {
            const commentId = this.getAttribute('data-comment-id');
            document.getElementById(`reply-form-${commentId}`).style.display = 'none';
        });
    });
    
    // Reply form submissions
    document.querySelectorAll(`#comments-list-${activityId} .comment-reply-form`).forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const commentId = this.getAttribute('data-comment-id');
            const content = this.querySelector('.reply-textarea').value.trim();
            if (content) submitReply(commentId, content, this);
        });
    });
}

// ------------------
// Reply System
// ------------------
function submitReply(commentId, content, form) {
    const textarea = form.querySelector('.reply-textarea');
    const submitBtn = form.querySelector('.reply-submit-btn');
    const originalBtnHTML = submitBtn.innerHTML;
    
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Posting...';
    textarea.disabled = true;
    
    fetch('/post_comment_reply/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            comment_id: commentId,
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            textarea.value = '';
            form.style.display = 'none';
            loadReplies(commentId);
        } else {
            alert(data.error || 'Failed to post reply. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error posting reply:', error);
        alert('Failed to post reply. Please try again.');
    })
    .finally(() => {
        submitBtn.innerHTML = originalBtnHTML;
        textarea.disabled = false;
    });
}

function loadReplies(commentId) {
    const repliesList = document.getElementById(`replies-list-${commentId}`);
    if (!repliesList) return;
    
    repliesList.innerHTML = '<div style="padding: 8px; color: #8e8e8e;">Loading replies...</div>';
    
    fetch(`/get_comment_replies/${commentId}/`, {
        method: 'GET',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.replies?.length > 0) {
            renderReplies(commentId, data.replies);
        } else {
            repliesList.innerHTML = '';
        }
    })
    .catch(error => {
        console.error('Error loading replies:', error);
        repliesList.innerHTML = '<div style="padding: 8px; color: #ff0000;">Failed to load replies</div>';
    });
}

function renderReplies(commentId, replies) {
    const repliesList = document.getElementById(`replies-list-${commentId}`);
    if (!repliesList) return;
    
    const isDarkMode = document.body.classList.contains('dark-mode');
    
    repliesList.innerHTML = '';
    replies.forEach(reply => {
        const replyElement = document.createElement('div');
        replyElement.className = 'reply-item';
        replyElement.style.marginTop = '8px';
        replyElement.style.padding = '8px';
        replyElement.style.background = isDarkMode ? '#2d2d2d' : '#f9f9f9';
        replyElement.style.borderRadius = '8px';
        replyElement.style.transition = 'background-color 0.3s ease';
        
        replyElement.innerHTML = `
            <div style="display: flex;">
                <div class="reply-user-pic" style="margin-right: 10px;">
                    <img src="${reply.user_image}" alt="${reply.username}" style="width: 32px; height: 32px; border-radius: 50%;" onerror="this.src='{% static 'images/default-profile.png' %}'">
                </div>
                <div class="reply-content" style="flex: 1;">
                    <div>
                        <span class="reply-username" style="font-weight: bold; color: ${isDarkMode ? '#f5f5f5' : '#262626'}">${reply.username}</span>
                        <span class="reply-text" style="color: ${isDarkMode ? '#e0e0e0' : '#000'}">${reply.content}</span>
                    </div>
                    <div class="reply-meta" style="font-size: 12px; color: ${isDarkMode ? '#aaa' : '#8e8e8e'}; margin-top: 4px;">
                        <span class="reply-timestamp">${reply.timestamp}</span>
                        <button class="reply-like-btn ${reply.liked ? 'liked' : ''}" data-reply-id="${reply.id}" 
                                style="margin-left: 8px; background: none; border: none; cursor: pointer; 
                                       color: ${reply.liked ? '#ed4956' : (isDarkMode ? '#aaa' : '#8e8e8e')}">
                            <i class="far fa-heart"></i> ${reply.like_count}
                        </button>
                    </div>
                </div>
            </div>
        `;
        repliesList.appendChild(replyElement);
        
        replyElement.querySelector('.reply-like-btn')?.addEventListener('click', function() {
            const replyId = this.getAttribute('data-reply-id');
            likeReply(replyId, this);
        });
    });
}

// ==============================================
// LIKE SYSTEM FUNCTIONS
// ==============================================

// ------------------
// Comment Likes
// ------------------
function likeComment(commentId, likeBtn) {
    const icon = likeBtn.querySelector('i');
    const isLiked = likeBtn.classList.contains('liked');
    const likeCountElement = likeBtn.querySelector('i').nextSibling;
    let likeCount = parseInt(likeCountElement.textContent.trim()) || 0;
    
    // Optimistic UI update
    if (isLiked) {
        likeBtn.classList.remove('liked');
        likeBtn.style.color = '#8e8e8e';
        icon.classList.replace('fas', 'far');
        likeCount--;
    } else {
        likeBtn.classList.add('liked');
        likeBtn.style.color = '#ed4956';
        icon.classList.replace('far', 'fas');
        likeCount++;
    }
    likeCountElement.textContent = ` ${likeCount}`;
    
    // AJAX request
    fetch('/like_activity_comment/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            comment_id: commentId,
            action: isLiked ? 'unlike' : 'like'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            // Revert UI if failed
            if (isLiked) {
                likeBtn.classList.add('liked');
                likeBtn.style.color = '#ed4956';
                icon.classList.replace('far', 'fas');
                likeCount++;
            } else {
                likeBtn.classList.remove('liked');
                likeBtn.style.color = '#8e8e8e';
                icon.classList.replace('fas', 'far');
                likeCount--;
            }
            likeCountElement.textContent = ` ${likeCount}`;
        }
    })
    .catch(error => {
        console.error('Error liking comment:', error);
        // Revert UI on error
        if (isLiked) {
            likeBtn.classList.add('liked');
            likeBtn.style.color = '#ed4956';
            icon.classList.replace('far', 'fas');
            likeCount++;
        } else {
            likeBtn.classList.remove('liked');
            likeBtn.style.color = '#8e8e8e';
            icon.classList.replace('fas', 'far');
            likeCount--;
        }
        likeCountElement.textContent = ` ${likeCount}`;
    });
}

// ------------------
// Reply Likes
// ------------------
function likeReply(replyId, likeBtn) {
    const icon = likeBtn.querySelector('i');
    const isLiked = likeBtn.classList.contains('liked');
    const likeCountElement = likeBtn.querySelector('i').nextSibling;
    let likeCount = parseInt(likeCountElement.textContent.trim()) || 0;
    
    // Optimistic UI update
    if (isLiked) {
        likeBtn.classList.remove('liked');
        likeBtn.style.color = '#8e8e8e';
        icon.classList.replace('fas', 'far');
        likeCount--;
    } else {
        likeBtn.classList.add('liked');
        likeBtn.style.color = '#ed4956';
        icon.classList.replace('far', 'fas');
        likeCount++;
    }
    likeCountElement.textContent = ` ${likeCount}`;
    
    // AJAX request
    fetch('/like_comment_reply/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            reply_id: replyId,
            action: isLiked ? 'unlike' : 'like'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            // Revert UI if failed
            if (isLiked) {
                likeBtn.classList.add('liked');
                likeBtn.style.color = '#ed4956';
                icon.classList.replace('far', 'fas');
                likeCount++;
            } else {
                likeBtn.classList.remove('liked');
                likeBtn.style.color = '#8e8e8e';
                icon.classList.replace('fas', 'far');
                likeCount--;
            }
            likeCountElement.textContent = ` ${likeCount}`;
        }
    })
    .catch(error => {
        console.error('Error liking reply:', error);
        // Revert UI on error
        if (isLiked) {
            likeBtn.classList.add('liked');
            likeBtn.style.color = '#ed4956';
            icon.classList.replace('far', 'fas');
            likeCount++;
        } else {
            likeBtn.classList.remove('liked');
            likeBtn.style.color = '#8e8e8e';
            icon.classList.replace('fas', 'far');
            likeCount--;
        }
        likeCountElement.textContent = ` ${likeCount}`;
    });
}


// ------------------
// Comment Submission
// ------------------
function submitComment(activityId, content, form) {
    const textarea = form.querySelector('.comment-textarea');
    const submitBtn = form.querySelector('.comment-submit-btn');
    const originalBtnHTML = submitBtn.innerHTML;
    
    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    textarea.disabled = true;
    
    fetch('/post_activity_comment/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            activity_id: activityId,
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Clear textarea and reload comments
            textarea.value = '';
            loadComments(activityId);
            
            // Update comment count
            const commentCountElement = document.querySelector(`.comment-count[data-activity-id="${activityId}"]`);
            if (commentCountElement) {
                const currentCount = parseInt(commentCountElement.textContent) || 0;
                commentCountElement.textContent = currentCount + 1;
            }
        } else {
            alert(data.error || 'Failed to post comment. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error posting comment:', error);
        alert('Failed to post comment. Please try again.');
    })
    .finally(() => {
        submitBtn.innerHTML = originalBtnHTML;
        textarea.disabled = false;
    });
}

// ==============================================
// INITIALIZATION
// ==============================================
document.addEventListener('DOMContentLoaded', function() {
    // View all comments links
    document.querySelectorAll('.view-all-comments').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const activityId = this.getAttribute('data-activity-id');
            loadComments(activityId, true);
            this.style.display = 'none';
        });
    });
    
    // Comment form submission
    document.querySelectorAll('.activity-comment-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const activityId = this.getAttribute('data-activity-id');
            const content = this.querySelector('.comment-textarea').value.trim();
            if (content) submitComment(activityId, content, this);
        });
    });
    
    // Close comment sections when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.comment-section') && 
            !e.target.closest('.icon.comment') && 
            !e.target.classList.contains('icon') && 
            !e.target.classList.contains('comment')) {
            document.querySelectorAll('.comment-section').forEach(section => {
                section.style.display = 'none';
            });
        }
    });
});
</script>
<script type="text/javascript">
    // Modify the loadReplies function to show a "View Replies" button when replies exist
function loadReplies(commentId) {
    const repliesList = document.getElementById(`replies-list-${commentId}`);
    if (!repliesList) return;
    
    // Check if we already have a "View Replies" button
    if (!repliesList.previousElementSibling || !repliesList.previousElementSibling.classList.contains('view-replies-btn')) {
        const viewRepliesBtn = document.createElement('button');
        viewRepliesBtn.className = 'view-replies-btn';
        viewRepliesBtn.setAttribute('data-comment-id', commentId);
        viewRepliesBtn.innerHTML = '<i class="fas fa-chevron-down"></i> View replies';
        viewRepliesBtn.style.margin = '5px 0';
        viewRepliesBtn.style.background = 'none';
        viewRepliesBtn.style.border = 'none';
        viewRepliesBtn.style.color = '#8e8e8e';
        viewRepliesBtn.style.cursor = 'pointer';
        
        viewRepliesBtn.addEventListener('click', function() {
            this.style.display = 'none';
            fetchReplies(commentId);
        });
        
        repliesList.parentNode.insertBefore(viewRepliesBtn, repliesList);
    }
    
    // Initially hide the replies list
    repliesList.style.display = 'none';
}

// Separate function to actually fetch replies
function fetchReplies(commentId) {
    const repliesList = document.getElementById(`replies-list-${commentId}`);
    if (!repliesList) return;
    
    repliesList.innerHTML = '<div style="padding: 8px; color: #8e8e8e;">Loading replies...</div>';
    repliesList.style.display = 'block';
    
    fetch(`/get_comment_replies/${commentId}/`, {
        method: 'GET',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.replies?.length > 0) {
            renderReplies(commentId, data.replies);
        } else {
            repliesList.innerHTML = '<div style="padding: 8px; color: #8e8e8e;">No replies yet</div>';
        }
    })
    .catch(error => {
        console.error('Error loading replies:', error);
        repliesList.innerHTML = '<div style="padding: 8px; color: #ff0000;">Failed to load replies</div>';
    });
}
</script>




<style type="text/css">
    /* Add these styles to your existing CSS */
.comment-section {
    margin-top: 12px;
    border-top: 1px solid #efefef;
    padding: 12px 16px 0;
    background-color: #fafafa;
    border-radius: 0 0 8px 8px;
}

body.dark-mode .comment-section {
    border-top-color: #333;
    background-color: #1e1e1e;
}

.comments-list {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 8px;
}

.comment-item {
    display: flex;
    margin-bottom: 12px;
    padding: 8px;
    border-radius: 4px;
    transition: background-color 0.2s ease;
}

.comment-item:hover {
    background-color: rgba(0, 0, 0, 0.02);
}

body.dark-mode .comment-item:hover {
    background-color: rgba(255, 255, 255, 0.05);
}

.comment-user-pic {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    margin-right: 10px;
    flex-shrink: 0;
}

.comment-user-pic img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.comment-content {
    flex-grow: 1;
}

.comment-username {
    font-weight: 600;
    font-size: 13px;
    margin-right: 6px;
    color: #262626;
}

body.dark-mode .comment-username {
    color: #f5f5f5;
}

.comment-text {
    font-size: 14px;
    line-height: 1.4;
    margin-top: 2px;
    word-break: break-word;
}

.comment-meta {
    display: flex;
    align-items: center;
    margin-top: 4px;
}

.comment-timestamp {
    font-size: 11px;
    color: #8e8e8e;
    margin-right: 10px;
}

.comment-reply-btn {
    font-size: 11px;
    color: #8e8e8e;
    font-weight: 600;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
}

.comment-reply-btn:hover {
    color: #0095f6;
}

.comment-like-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    margin-left: 10px;
    color: #8e8e8e;
    font-size: 12px;
}

.comment-like-btn.liked {
    color: #ed4956;
}

.comment-like-btn i {
    font-size: 12px;
    margin-right: 4px;
}

.view-all-comments {
    display: block;
    color: #8e8e8e;
    font-size: 14px;
    margin-bottom: 8px;
    text-decoration: none;
}

.view-all-comments:hover {
    color: #0095f6;
}

/* Scrollbar styling */
.comments-list::-webkit-scrollbar {
    width: 6px;
}

.comments-list::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.comments-list::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
}

.comments-list::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

body.dark-mode .comments-list::-webkit-scrollbar-track {
    background: #2a2a2a;
}

body.dark-mode .comments-list::-webkit-scrollbar-thumb {
    background: #4a4a4a;
}

body.dark-mode .comments-list::-webkit-scrollbar-thumb:hover {
    background: #5a5a5a;
}



.comment-reply-btn {
    background: none;
    border: none;
    color: #8e8e8e;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    padding: 0;
    margin-right: 10px;
}

.comment-reply-btn:hover {
    color: #0095f6;
    text-decoration: underline;
}

.reply-form-container {
    margin-top: 10px;
    padding: 10px;
    background: #f9f9f9;
    border-radius: 8px;
}

.reply-textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    resize: vertical;
    min-height: 50px;
    margin-bottom: 8px;
}

.reply-form-buttons {
    display: flex;
    gap: 8px;
}

.reply-submit-btn, .cancel-reply-btn {
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
}

.reply-submit-btn {
    background: #0095f6;
    color: white;
    border: none;
}

.cancel-reply-btn {
    background: #efefef;
    color: #262626;
    border: none;
}


/* Dark Mode Base Styles */
body.dark-mode {
    background-color: #121212;
    color: #e0e0e0;
}

/* Activity Item Dark Mode */
body.dark-mode .activity-item {
    background-color: #1e1e1e;
    border-color: #333;
}

body.dark-mode .activity-content,
body.dark-mode .activity-title,
body.dark-mode .campaign-link {
    color: #e0e0e0;
}

body.dark-mode .activity-timestamp,
body.dark-mode .activity-count {
    color: #b0b0b0;
}

/* Comment Section Dark Mode */
body.dark-mode .comment-section {
    background-color: #1e1e1e;
    border-top-color: #333;
}

body.dark-mode .comment-textarea {
    background-color: #2d2d2d;
    color: #e0e0e0;
    border-color: #444;
}

body.dark-mode .comment-textarea::placeholder {
    color: #888;
}

body.dark-mode .comment-item {
    background-color: #252525;
}

body.dark-mode .comment-username {
    color: #f5f5f5;
}

body.dark-mode .comment-text {
    color: #e0e0e0;
}

body.dark-mode .comment-timestamp,
body.dark-mode .view-all-comments {
    color: #aaa;
}

body.dark-mode .comment-reply-btn,
body.dark-mode .comment-like-btn {
    color: #aaa;
}

body.dark-mode .comment-reply-btn:hover,
body.dark-mode .view-all-comments:hover {
    color: #0095f6;
}

/* Reply Form Dark Mode */
body.dark-mode .reply-form-container {
    background-color: #252525;
}

body.dark-mode .reply-textarea {
    background-color: #2d2d2d;
    color: #e0e0e0;
    border-color: #444;
}

body.dark-mode .cancel-reply-btn {
    background-color: #333;
    color: #e0e0e0;
}

/* Activity Interactions Dark Mode */
body.dark-mode .interaction-icons .icon {
    color: #aaa;
}

body.dark-mode .interaction-icons .icon:hover {
    color: #e0e0e0;
}

body.dark-mode .love-count {
    color: #aaa;
}

/* Menu Popup Dark Mode */
body.dark-mode .menu-popup {
    background-color: #2d2d2d;
    border-color: #444;
}

body.dark-mode .menu-item {
    color: #e0e0e0;
}

body.dark-mode .menu-item:hover {
    background-color: #333;
}


/* Dark mode styles for replies */
body.dark-mode .reply-item {
    background-color: #2d2d2d;
    border: 1px solid #444;
}

body.dark-mode .reply-username {
    color: #f5f5f5 !important;
}

body.dark-mode .reply-text {
    color: #e0e0e0 !important;
}

body.dark-mode .reply-meta {
    color: #aaa !important;
}

body.dark-mode .reply-like-btn {
    color: #aaa !important;
}

body.dark-mode .reply-like-btn.liked {
    color: #ed4956 !important;
}

body.dark-mode .view-replies-btn {
    color: #aaa !important;
}

body.dark-mode .view-replies-btn:hover {
    color: #4db2ff !important;
}
</style>


<script type="text/javascript">
document.addEventListener('DOMContentLoaded', () => {
    // Click event listener for showing the share options
    document.body.addEventListener('click', function(event) {
        const shareIcon = event.target.closest('.share-icon');
        if (shareIcon) {
            const activityId = shareIcon.getAttribute('onclick').match(/\d+/)[0];  // Get activity ID
            const shareOptions = document.getElementById(`shareOptions-${activityId}`);

            // Close all other share options
            document.querySelectorAll('.share-options').forEach(option => {
                if (option !== shareOptions) {
                    option.style.display = 'none';
                }
            });

            // Toggle current share options
            shareOptions.style.display = shareOptions.style.display === 'block' ? 'none' : 'block';
        }
    });

    // Close share options when clicking outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.share-wrapper')) {
            document.querySelectorAll('.share-options').forEach(option => {
                option.style.display = 'none';
            });
        }
    });
});
</script>



    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const videos = document.querySelectorAll('video');
            const options = {
                root: null,
                rootMargin: '0px',
                threshold: 0.5
            };

            const observer = new IntersectionObserver(function(entries, observer) {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        // Play and unmute the video
                        entry.target.play();
                        entry.target.muted = false;
                    } else {
                        // Pause the video
                        entry.target.pause();
                    }
                });
            }, options);

            videos.forEach(video => {
                observer.observe(video);
                
                // Check if the video is initially in the viewport after page refresh
                const rect = video.getBoundingClientRect();
                const windowHeight = window.innerHeight || document.documentElement.clientHeight;
                if (rect.top >= 0 && rect.bottom <= windowHeight) {
                    // Play and unmute if video is in the viewport
                    video.play();
                    video.muted = false;
                }
            });
        });






        // Function to handle file upload and playback
        function uploadAudio() {
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = 'audio/*, video/*'; // Limit file selection to audio files

            // Listen for file selection
            input.onchange = function(e) {
                var file = e.target.files[0];
                var audio = document.getElementById('bgAudio');

                // Pause the current audio playback
                audio.pause();

                // Store the selected audio file and its playback position in local storage
                localStorage.setItem('bgAudioFile', URL.createObjectURL(file));
                localStorage.setItem('bgAudioPosition', audio.currentTime);

                // Set the audio source to the selected file
                audio.src = localStorage.getItem('bgAudioFile');

                // Resume audio playback
                audio.play();
            };

            // Trigger the file input
            input.click();
        }

        // Function to set background audio on page load
        window.onload = function() {
            var audio = document.getElementById('bgAudio');
            var bgAudioFile = localStorage.getItem('bgAudioFile');
            var audioPosition = parseFloat(localStorage.getItem('bgAudioPosition'));

            // Check if there's a stored audio file
            if (bgAudioFile) {
                // Set the audio source to the stored file
                audio.src = bgAudioFile;

                // Set the playback position if available
                if (!isNaN(audioPosition)) {
                    audio.currentTime = audioPosition;
                }

                // Autoplay the audio
                audio.play();
            }
        };

        // Store current playback position before page refresh
        window.addEventListener('beforeunload', function() {
            var audio = document.getElementById('bgAudio');
            localStorage.setItem('bgAudioPosition', audio.currentTime);
        });



document.addEventListener('DOMContentLoaded', function() {
    var campaignElement = document.querySelector('.campaign-details');
    var campaignId = {{ campaign.id }};
    var startTime;

    function recordCampaignView() {
        var endTime = Math.floor(Date.now() / 1000); // Get current time in seconds
        var timeSpent = endTime - startTime;
        
        fetch(`/record_campaign_view/${campaignId}/`, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ time_spent: timeSpent })
        })
        .then(response => {
            if (response.ok) {
                console.log('View recorded successfully');
            } else {
                console.error('Failed to record view');
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function handleVisibilityChange() {
        if (document.visibilityState === 'visible') {
            startTime = Math.floor(Date.now() / 1000); // Get current time in seconds
        } else {
            recordCampaignView();
        }
    }

    function isInViewport(element) {
        var rect = element.getBoundingClientRect();
        return (
            rect.top >= 0 &&
            rect.left >= 0 &&
            rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
            rect.right <= (window.innerWidth || document.documentElement.clientWidth)
        );
    }

    function handleScroll() {
        if (isInViewport(campaignElement)) {
            startTime = Math.floor(Date.now() / 1000); // Get current time in seconds
        } else {
            recordCampaignView();
        }
    }

    document.addEventListener('visibilitychange', handleVisibilityChange);
    document.addEventListener('scroll', handleScroll);
});

document.addEventListener('DOMContentLoaded', function() {
    var mediaQuery = window.matchMedia('(max-width: 768px)');
    var leftAside = document.querySelector('.left-aside');
    var rightAside = document.querySelector('.right-aside');

    function handleMediaQueryChange(e) {
        if (e.matches) {
            leftAside.style.display = 'none';
            rightAside.style.display = 'none';
        } else {
            leftAside.style.display = 'block';
            rightAside.style.display = 'block';
        }
    }

    mediaQuery.addListener(handleMediaQueryChange);
    handleMediaQueryChange(mediaQuery);
});


</script>

<script type="text/javascript">
function switchColor() {
    const body = document.body;
    const isDarkMode = body.classList.toggle('dark-mode'); // Toggle dark mode class
    var reactDivs = document.querySelectorAll('.react');

    // Update background and text colors for all elements
    const elementsToUpdate = document.querySelectorAll(
        'header, footer, section, .left-aside, .right-aside, .upper-post, .campaign-content, .react, .search-container input, .search-container .btn-reset'
    );

    elementsToUpdate.forEach(element => {
        element.classList.toggle('dark-mode', isDarkMode);
    });

    // Update text colors for specific elements
    const textElements = document.querySelectorAll(
        'h1, h2, h3,  p, li, .campaign-nav, .campaign-nav a, .btn, .reaction, .action-item, .action-item a, .carousel, .ad, .slide, .ad a, .explore-link, .love-count, #view-count, .comment-count'
    );

    textElements.forEach(element => {
        element.style.color = isDarkMode ? '#ffffff' : '#000000';
    });

    // Update buttons
    const buttons = document.querySelectorAll('button:not(.btn-search, .btn-reset)');
    buttons.forEach(button => {
        button.style.backgroundColor = isDarkMode ? '#262626' : '';
        button.style.color = isDarkMode ? '#ffffff' : '#000000';
    });

    // Update `.react` divs
    if (reactDivs.length > 0) {
        reactDivs.forEach(function(reactDiv) {
            reactDiv.style.backgroundColor = isDarkMode ? "#262626" : "";
            reactDiv.style.color = isDarkMode ? "white" : "black";

            if (isDarkMode) {
                reactDiv.classList.add('react-hover');
            } else {
                reactDiv.classList.remove('react-hover');
                reactDiv.style.backgroundColor = "";
            }
        });
    }

    // Update input field and reset button
    const inputField = document.querySelector('.search-container input[type="text"]');
    const inputResetButton = document.querySelector('.search-container .btn-reset');

    if (inputField) {
        inputField.style.backgroundColor = isDarkMode ? '#333333' : '#ffffff';
        inputField.style.color = isDarkMode ? '#ffffff' : '#000000';
    }

    if (inputResetButton) {
        inputResetButton.style.color = '#b0b0b0';
    }
}

</script>



{% endblock %}
