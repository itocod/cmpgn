{% extends 'main/face.html' %}
{% load static %}

{% block content %}

<!-- Add emoji picker library -->
<script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js" type="module"></script>

<style type="text/css">
  /* WhatsApp-inspired chat room - Compact Enhanced Version */
  .chat-room-container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    max-width: 100%;
    margin: 0;
    padding: 0;
    background: #e5ddd5;
    position: relative;
    overflow: hidden;
  }

  /* Multi-layer Watermark Design with Charity Themes - Enhanced Text Sizes */
  .chat-room-container::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: 
      url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400" viewBox="0 0 400 400" opacity="0.04"><path d="M50,50 Q200,25 350,50" fill="none" stroke="%23075e54" stroke-width="2"/><path d="M25,200 Q175,175 325,200" fill="none" stroke="%23075e54" stroke-width="2"/><path d="M50,350 Q200,325 350,350" fill="none" stroke="%23075e54" stroke-width="2"/><text x="200" y="80" font-family="Arial" font-size="28" text-anchor="middle" fill="%23075e54" font-weight="bold">Together We Can</text><text x="200" y="120" font-family="Arial" font-size="22" text-anchor="middle" fill="%23075e54">Make a Difference</text><text x="200" y="160" font-family="Arial" font-size="18" text-anchor="middle" fill="%23075e54">Every Contribution Counts</text><text x="200" y="200" font-family="Arial" font-size="18" text-anchor="middle" fill="%23075e54">Fundraising for Change</text><text x="200" y="240" font-family="Arial" font-size="18" text-anchor="middle" fill="%23075e54">Support the Cause</text><text x="200" y="280" font-family="Arial" font-size="18" text-anchor="middle" fill="%23075e54">Give Hope</text><circle cx="200" cy="40" r="10" fill="%23075e54"/><circle cx="120" cy="350" r="8" fill="%23075e54"/><circle cx="280" cy="350" r="8" fill="%23075e54"/></svg>'),
      url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="250" height="250" viewBox="0 0 250 250" opacity="0.03"><path d="M30,30 Q125,15 220,30" fill="none" stroke="%23128c7e" stroke-width="1.5"/><path d="M15,125 Q110,110 205,125" fill="none" stroke="%23128c7e" stroke-width="1.5"/><path d="M30,220 Q125,205 220,220" fill="none" stroke="%23128c7e" stroke-width="1.5"/><text x="125" y="60" font-family="Arial" font-size="18" text-anchor="middle" fill="%23128c7e">Charity</text><text x="125" y="90" font-family="Arial" font-size="16" text-anchor="middle" fill="%23128c7e">Compassion</text><text x="125" y="120" font-family="Arial" font-size="16" text-anchor="middle" fill="%23128c7e">Kindness</text><text x="125" y="170" font-family="Arial" font-size="16" text-anchor="middle" fill="%23128c7e">Empathy</text><text x="125" y="200" font-family="Arial" font-size="16" text-anchor="middle" fill="%23128c7e">Community</text><circle cx="125" cy="230" r="6" fill="%23128c7e"/></svg>'),
      url('data:image/svg+xml;utf8,<svg xmlns="http://www/w3.org/2000/svg" width="180" height="180" viewBox="0 0 180 180" opacity="0.02"><path d="M20,20 Q90,10 160,20" fill="none" stroke="%2325d366" stroke-width="1"/><path d="M10,90 Q80,80 150,90" fill="none" stroke="%2325d366" stroke-width="1"/><path d="M20,160 Q90,150 160,160" fill="none" stroke="%2325d366" stroke-width="1"/><text x="90" y="50" font-family="Arial" font-size="14" text-anchor="middle" fill="%2325d366">Donate</text><text x="90" y="80" font-family="Arial" font-size="12" text-anchor="middle" fill="%2325d366">Volunteer</text><text x="90" y="110" font-family="Arial" font-size="12" text-anchor="middle" fill="%2325d366">Support</text><text x="90" y="150" font-family="Arial" font-size="12" text-anchor="middle" fill="%2325d366">Inspire</text><text x="90" y="170" font-family="Arial" font-size="12" text-anchor="middle" fill="%2325d366">Care</text></svg>');
    background-repeat: repeat;
    background-size: 400px 400px, 250px 250px, 180px 180px;
    pointer-events: none;
    z-index: 0;
  }

  /* Dark mode background with enhanced watermark */
  body.dark-mode .chat-room-container {
    background: #0d1418;
  }

  body.dark-mode .chat-room-container::before {
    background-image: 
      url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400" viewBox="0 0 400 400" opacity="0.05"><path d="M50,50 Q200,25 350,50" fill="none" stroke="%2300af9c" stroke-width="2"/><path d="M25,200 Q175,175 325,200" fill="none" stroke="%2300af9c" stroke-width="2"/><path d="M50,350 Q200,325 350,350" fill="none" stroke="%2300af9c" stroke-width="2"/><text x="200" y="80" font-family="Arial" font-size="28" text-anchor="middle" fill="%2300af9c" font-weight="bold">Change Lives</text><text x="200" y="120" font-family="Arial" font-size="22" text-anchor="middle" fill="%2300af9c">Spread Hope</text><text x="200" y="160" font-family="Arial" font-size="18" text-anchor="middle" fill="%2300af9c">Fundraising Goals</text><text x="200" y="200" font-family="Arial" font-size="18" text-anchor="middle" fill="%2300af9c">Social Impact</text><text x="200" y="240" font-family="Arial" font-size="18" text-anchor="middle" fill="%2300af9c">Be the Change</text><text x="200" y="280" font-family="Arial" font-size="18" text-anchor="middle" fill="%2300af9c">Give Back</text><circle cx="200" cy="40" r="10" fill="%2300af9c"/><circle cx="120" cy="350" r="8" fill="%2300af9c"/><circle cx="280" cy="350" r="8" fill="%2300af9c"/></svg>'),
      url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="250" height="250" viewBox="0 0 250 250" opacity="0.04"><path d="M30,30 Q125,15 220,30" fill="none" stroke="%2300e676" stroke-width="1.5"/><path d="M15,125 Q110,110 205,125" fill="none" stroke="%2300e676" stroke-width="1.5"/><path d="M30,220 Q125,205 220,220" fill="none" stroke="%2300e676" stroke-width="1.5"/><text x="125" y="60" font-family="Arial" font-size="18" text-anchor="middle" fill="%2300e676">Generosity</text><text x="125" y="90" font-family="Arial" font-size="16" text-anchor="middle" fill="%2300e676">Philanthropy</text><text x="125" y="120" font-family="Arial" font-size="16" text-anchor="middle" fill="%2300e676">Solidarity</text><text x="125" y="170" font-family="Arial" font-size="16" text-anchor="middle" fill="%2300e676">Advocacy</text><text x="125" y="200" font-family="Arial" font-size="16" text-anchor="middle" fill="%2300e676">Unity</text><circle cx="125" cy="230" r="6" fill="%2300e676"/></svg>'),
      url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="180" height="180" viewBox="0 0 180 180" opacity="0.03"><path d="M20,20 Q90,10 160,20" fill="none" stroke="%2334b7f1" stroke-width="1"/><path d="M10,90 Q80,80 150,90" fill="none" stroke="%2334b7f1" stroke-width="1"/><path d="M20,160 Q90,150 160,160" fill="none" stroke="%2334b7f1" stroke-width="1"/><text x="90" y="50" font-family="Arial" font-size="14" text-anchor="middle" fill="%2334b7f1">Campaign</text><text x="90" y="80" font-family="Arial" font-size="12" text-anchor="middle" fill="%2334b7f1">Donations</text><text x="90" y="110" font-family="Arial" font-size="12" text-anchor="middle" fill="%2334b7f1">Awareness</text><text x="90" y="150" font-family="Arial" font-size="12" text-anchor="middle" fill="%2334b7f1">Empower</text><text x="90" y="170" font-family="Arial" font-size="12" text-anchor="middle" fill="%2334b7f1">Serve</text></svg>');
  }

  /* Make sure content is above watermark */
  .chat-header,
  .messages-container,
  .message-input-area,
  .participants-section,
  .management-section {
    position: relative;
    z-index: 1;
  }

  /* Chat Header */
  .chat-header {
    background: #075e54;
    color: white;
    padding: 10px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    z-index: 10;
    position: relative;
    flex-shrink: 0;
  }

  .chat-title {
    font-size: 18px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Chat messages area */
  .messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 10px 16px;
    background-image: url('{% static "images/whatsapp-bg.png" %}');
    background-size: contain;
    background-attachment: fixed;
    display: flex;
    flex-direction: column;
    -webkit-overflow-scrolling: touch;
  }

  .dark-mode .messages-container {
    background-image: url('{% static "images/whatsapp-bg-dark.png" %}');
  }

  /* Message container */
  .message-container {
    display: flex;
    margin-bottom: 8px;
    position: relative;
    animation: fadeIn 0.3s ease-out;
    align-items: flex-start;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Message bubbles */
  .message {
    max-width: 80%;
    padding: 8px 12px;
    border-radius: 7.5px;
    position: relative;
    word-wrap: break-word;
  }

  .own-message-container {
    justify-content: flex-end;
  }

  .own-message {
    background: #dcf8c6;
    border-top-right-radius: 0;
    margin-left: 20%;
  }

  .dark-mode .own-message {
    background: #056162;
    color: #e7e7e7;
  }

  .other-message-container {
    justify-content: flex-start;
  }

  .other-message {
    background: white;
    border-top-left-radius: 0;
    margin-right: 20%;
  }

  .dark-mode .other-message {
    background: #262d31;
    color: #e7e7e7;
  }

  /* Profile picture for other users */
  .message-profile-pic {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 8px;
    align-self: flex-start;
    margin-top: 4px;
  }

  /* Message metadata */
  .message-info {
    display: flex;
    justify-content: space-between;
    margin-top: 4px;
    font-size: 11px;
    color: #666;
  }

  .dark-mode .message-info {
    color: #a6a8aa;
  }

  .own-message .message-info {
    text-align: right;
  }

  /* Sender name */
  .sender-name {
    font-weight: bold;
    margin-bottom: 2px;
    color: #075e54;
  }

  .dark-mode .sender-name {
    color: #00af9c;
  }

  /* Profile pictures */
  .profile-pic {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 10px;
    border: 1px solid #eee;
  }

  /* Input area */
  .message-input-area {
    background: #f0f0f0;
    padding: 8px 16px;
    display: flex;
    align-items: center;
    border-top: 1px solid #ddd;
    flex-shrink: 0;
  }

  .dark-mode .message-input-area {
    background: #1e2428;
    border-top-color: #333;
  }

  .message-input {
    flex: 1;
    padding: 10px 15px;
    border-radius: 21px;
    border: none;
    outline: none;
    font-size: 15px;
    margin: 0 8px;
    background: white;
    box-shadow: 0 1px 1px rgba(0,0,0,0.08);
    min-height: 20px;
    max-height: 100px;
    overflow-y: auto;
    resize: none;
  }

  .dark-mode .message-input {
    background: #33383b;
    color: white;
  }

  .send-button {
    background: #075e54;
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s;
    flex-shrink: 0;
  }

  .send-button:hover {
    background: #054d44;
  }

  .dark-mode .send-button {
    background: #00af9c;
  }

  /* Participants section */
  .participants-section {
    background: white;
    padding: 12px 16px;
    border-bottom: 1px solid #eee;
    max-height: 50vh;
    overflow-y: auto;
  }

  .dark-mode .participants-section {
    background: #2a2f32;
    border-bottom-color: #333;
  }

  .participant {
    display: flex;
    align-items: center;
    padding: 8px 0;
  }

  /* Management sections */
  .management-section {
    background: white;
    padding: 15px;
    margin: 0;
    border-radius: 0;
    box-shadow: none;
    max-height: 60vh;
    overflow-y: auto;
  }

  .dark-mode .management-section {
    background: #2a2f32;
  }

  .management-section h4 {
    margin-top: 0;
    margin-bottom: 10px;
    color: #075e54;
  }

  .dark-mode .management-section h4 {
    color: #00af9c;
  }

  .participant-checkbox {
    display: flex;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
  }

  .dark-mode .participant-checkbox {
    border-bottom-color: #333;
  }

  .action-btn {
    padding: 8px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    margin-top: 10px;
    width: 100%;
    box-sizing: border-box;
  }

  .add-btn {
    background: #4CAF50;
    color: white;
  }

  .remove-btn {
    background: #f44336;
    color: white;
  }

  .delete-btn {
    background: #f44336;
    color: white;
    margin-top: 20px;
  }

  /* Dropdown menu */
  .dropdown {
    position: relative;
    display: inline-block;
  }

  .dropdown-content {
    display: none;
    position: absolute;
    right: 0;
    background-color: #f9f9f9;
    min-width: 160px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    z-index: 1;
    border-radius: 4px;
  }

  .dark-mode .dropdown-content {
    background-color: #333;
  }

  .dropdown-content a {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
  }

  .dark-mode .dropdown-content a {
    color: white;
  }

  .dropdown-content a:hover {
    background-color: #f1f1f1;
  }

  .dark-mode .dropdown-content a:hover {
    background-color: #444;
  }

  .dropdown:hover .dropdown-content {
    display: block;
  }

  /* Success message */
  #successMessage {
    display: none;
    background: #4CAF50;
    color: white;
    padding: 8px 15px;
    border-radius: 4px;
    margin: 10px;
    text-align: center;
  }

  /* Spinner */
  .spinner {
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top: 2px solid white;
    width: 16px;
    height: 16px;
    animation: spin 1s linear infinite;
    display: inline-block;
    vertical-align: middle;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Date divider */
  .date-divider {
    text-align: center;
    margin: 10px 0;
    position: relative;
  }

  .date-divider span {
    background: rgba(225,245,254,0.7);
    padding: 4px 12px;
    border-radius: 14px;
    font-size: 12px;
    color: #607d8b;
    position: relative;
    z-index: 1;
  }

  .dark-mode .date-divider span {
    background: rgba(33,33,33,0.7);
    color: #b0bec5;
  }

  .date-divider:before {
    content: "";
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 1px;
    background: rgba(0,0,0,0.1);
    z-index: 0;
  }

  /* Media display styles */
  .message-media-container {
    margin-top: 5px;
    max-width: 100%;
    border-radius: 8px;
    overflow: hidden;
  }
  
  .message-media-container img,
  .message-media-container video {
    max-width: 100%;
    border-radius: 8px;
    max-height: 300px;
    object-fit: contain;
    display: block;
  }
  
  .message-file-container {
    padding: 10px;
    background: rgba(0,0,0,0.05);
    border-radius: 8px;
    margin-top: 5px;
  }
  
  .dark-mode .message-file-container {
    background: rgba(255,255,255,0.1);
  }
  
  .file-download-btn {
    display: inline-block;
    margin-top: 5px;
    padding: 5px 10px;
    background-color: #4CAF50;
    color: white;
    border-radius: 4px;
    font-size: 12px;
    text-decoration: none;
    cursor: pointer;
  }
  
  .file-icon {
    margin-right: 5px;
    vertical-align: middle;
    font-size: 16px;
  }

  /* Mobile optimizations */
  @media (max-width: 768px) {
    .chat-room-container {
      height: 100vh;
      max-height: -webkit-fill-available;
    }
    
    .message {
      max-width: 85%;
    }
    
    .own-message {
      margin-left: 15%;
    }
    
    .other-message {
      margin-right: 15%;
    }
    
    .management-section {
      max-height: 50vh;
    }
    
    .participants-section {
      max-height: 50vh;
    }
    
    .message-input {
      font-size: 14px;
      padding: 8px 12px;
    }
    
    .profile-pic {
      width: 28px;
      height: 28px;
    }
    
    .message-profile-pic {
      width: 28px;
      height: 28px;
    }
  }
</style>
<style type="text/css">
  /* [All your existing CSS remains the same] */
  
  /* Image preview modal styles */
  .image-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    overflow: auto;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .image-modal.show {
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 1;
  }
  
  .modal-content {
    display: block;
    max-width: 90%;
    max-height: 90%;
    margin: auto;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
  }
  
  .close-modal {
    position: absolute;
    top: 20px;
    right: 30px;
    color: #f1f1f1;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
    transition: 0.3s;
  }
  
  .close-modal:hover {
    color: #bbb;
  }
  
  .modal-caption {
    position: absolute;
    bottom: 20px;
    left: 0;
    right: 0;
    text-align: center;
    color: white;
    padding: 10px;
    background: rgba(0, 0, 0, 0.5);
  }
  
  .download-image-btn {
    position: absolute;
    bottom: 70px;
    right: 30px;
    background-color: #075e54;
    color: white;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
  }
  
  .dark-mode .download-image-btn {
    background-color: #00af9c;
  }
  
  /* Make images in messages clickable */
  .message-media-container {
    cursor: pointer;
    transition: transform 0.2s;
  }
  
  .message-media-container:hover {
    transform: scale(1.02);
  }
</style>

<style type="text/css">
  /* [All your existing CSS remains the same] */
  
  /* Emoji picker styles */
  emoji-picker {
    --num-columns: 8;
    --emoji-size: 24px;
    --border-radius: 8px;
    --category-emoji-size: 18px;
    --background: #fff;
    --border-color: #e0e0e0;
    --indicator-color: #075e54;
    --input-border-color: #e0e0e0;
    --input-font-size: 14px;
    --outline-size: 0;
    --category-font-size: 12px;
    --font-family: inherit;
    height: 300px;
    width: 100%;
    max-width: 350px;
    position: absolute;
    bottom: 60px;
    right: 10px;
    z-index: 1000;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    border-radius: 12px;
    display: none;
  }

  .dark-mode emoji-picker {
    --background: #2a2f32;
    --border-color: #444;
    --indicator-color: #00af9c;
    --input-border-color: #444;
    --text-color: #e7e7e7;
    --input-background: #33383b;
  }

  @media (max-width: 768px) {
    emoji-picker {
      max-width: 280px;
      right: 5px;
      bottom: 55px;
    }
  }
</style>

<!-- Image Preview Modal -->
<div id="imageModal" class="image-modal">
  <span class="close-modal">&times;</span>
  <img class="modal-content" id="modalImage">
  <div class="modal-caption" id="modalCaption"></div>
  <a id="downloadImageBtn" class="download-image-btn" download>
    <i class="material-icons">file_download</i>
  </a>
</div>

<div class="chat-room-container">
  <!-- Chat Header -->
  <div class="chat-header">
    <div class="chat-title">
      <img src="{{ chat.manager.profile.image.url }}" class="profile-pic" alt="{{ chat.manager.username }}">
      <div style="overflow: hidden;">
        <div style="overflow: hidden; text-overflow: ellipsis;">{{ chat.title }}</div>
        <div style="font-size: 12px;">
          {% if chat.participants.count == 1 %}
            1 participant
          {% else %}
            {{ chat.participants.count }} participants
          {% endif %}
        </div>
      </div>
    </div>
    <div class="dropdown">
      <i class="material-icons" style="cursor: pointer;">more_vert</i>
      <div class="dropdown-content">
        <a href="#" id="showParticipants">Show Participants</a>
        {% if chat.manager == user %}
          <a href="#" id="showManagement">Manage Chat</a>
        {% endif %}
      </div>
    </div>
  </div>
  
  <!-- Participants Section (Collapsible) -->
  <div class="participants-section" style="display: none;" id="participantsSection">
    <h4>Participants</h4>
    {% for participant in chat.participants.all %}
    <div class="participant">
      <img src="{{ participant.profile.image.url }}" class="profile-pic" alt="{{ participant.username }}">
      <div>
        <div>{{ participant.username }}</div>
        {% if participant.profile.profile_verified %}
        <div style="font-size: 12px; color: #4CAF50;">
          <i class="material-icons" style="font-size:12px;">verified_user</i> Verified
        </div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
  
  <!-- Management Section (Collapsible) -->
  {% if chat.manager == user %}
  <div class="management-section" style="display: none;" id="managementSection">
    <!-- Add Participants Form -->
    <h4>Add Participants</h4>
    <form method="post" action="{% url 'add_participants' chat.id %}" id="addParticipantsForm">
      {% csrf_token %}
      <div style="max-height: 30vh; overflow-y: auto;">
        {% for user_choice in user_choices %}
        <div class="participant-checkbox">
          <input type="checkbox" name="participants" value="{{ user_choice.pk }}" id="add-{{ user_choice.pk }}">
          <label for="add-{{ user_choice.pk }}" style="display: flex; align-items: center; gap: 8px; margin-left: 8px;">
            <img src="{{ user_choice.profile.image.url }}" class="profile-pic" alt="{{ user_choice.username }}">
            <span>{{ user_choice.username }}</span>
            {% if user_choice.profile.profile_verified %}
            <i class="material-icons" style="font-size:14px;color:green">verified_user</i>
            {% endif %}
          </label>
        </div>
        {% endfor %}
      </div>
      <button type="submit" class="action-btn add-btn">➕ Add Selected</button>
    </form>
    
    <hr style="margin: 15px 0; border-color: #eee;">
    
    <!-- Remove Participants Form -->
    <h4>Remove Participants</h4>
    <form method="post" action="{% url 'remove_participants' chat.id %}" id="removeParticipantsForm">
      {% csrf_token %}
      <div style="max-height: 30vh; overflow-y: auto;">
        {% for participant in chat.participants.all %}
        <div class="participant-checkbox">
          <input type="checkbox" name="participants" value="{{ participant.id }}" id="remove-{{ participant.id }}">
          <label for="remove-{{ participant.id }}" style="display: flex; align-items: center; gap: 8px; margin-left: 8px;">
            <img src="{{ participant.profile.image.url }}" class="profile-pic" alt="{{ participant.username }}">
            <span>{{ participant.username }}</span>
            {% if participant.profile.profile_verified %}
            <i class="material-icons" style="font-size:14px;color:green">verified_user</i>
            {% endif %}
          </label>
        </div>
        {% endfor %}
      </div>
      <button type="submit" class="action-btn remove-btn">❌ Remove Selected</button>
    </form>
    
    <!-- Delete Chat Form -->
    <form method="post" action="{% url 'delete_chat' chat.id %}" id="deleteChatForm">
      {% csrf_token %}
      <button type="submit" class="action-btn delete-btn">🗑️ Delete Chat</button>
    </form>
  </div>
  {% endif %}
   
  <!-- Messages Container - UPDATED WITH CLICKABLE IMAGES -->
  <div class="messages-container" id="messagesContainer">
    {% for message in messages %}
      {% ifchanged message.timestamp.date %}
        <div class="date-divider">
          <span>{{ message.timestamp|date:"F j, Y" }}</span>
        </div>
      {% endifchanged %}
      
      {% if message.sender == user %}
        <div class="message-container own-message-container">
          <div class="message own-message" id="message-{{ message.id }}" data-timestamp="{{ message.timestamp|date:'U' }}000">
            <div class="message-text">
              {% if message.file %}
                <!-- Display images and videos directly -->
                {% if message.file_type|slice:":5" == "image" %}
                  <div class="message-media-container" onclick="openImageModal('{{ message.file.url }}', '{{ message.sender.username }}', '{{ message.timestamp|date:"M j, Y" }}')">
                    <img src="{{ message.file.url }}" alt="Shared image">
                  </div>
                {% elif message.file_type|slice:":5" == "video" %}
                  <div class="message-media-container">
                    <video controls>
                      <source src="{{ message.file.url }}" type="{{ message.file_type }}">
                      Your browser does not support the video tag.
                    </video>
                  </div>
                {% else %}
                  <!-- For other file types, show download option -->
                  <div class="message-file-container">
                    <i class="material-icons file-icon">description</i>
                    <span>{{ message.file_name }}</span>
                    <a href="{{ message.file.url }}" download="{{ message.file_name }}" class="file-download-btn">
                      Download File
                    </a>
                  </div>
                {% endif %}
                
                {% if message.content and message.content != "say something.." %}
                  <div style="margin-top: 8px;">{{ message.content|safe }}</div>
                {% endif %}
              {% else %}
                {{ message.content|safe }}
              {% endif %}
            </div>
            
            <div class="message-info">
              <span class="message-time">{{ message.timestamp|time:"H:i" }}</span>
              <span class="message-status">
                <i class="material-icons" style="font-size:14px;">done_all</i>
              </span>
            </div>
          </div>
        </div>
      {% else %}
        <div class="message-container other-message-container">
          <img src="{{ message.sender.profile.image.url }}" class="message-profile-pic" alt="{{ message.sender.username }}">
          <div class="message other-message" id="message-{{ message.id }}" data-timestamp="{{ message.timestamp|date:'U' }}000">
            <div class="sender-name">~ {{ message.sender.username }}</div>
            <div class="message-text">
              {% if message.file %}
                <!-- Display images and videos directly -->
                {% if message.file_type|slice:":5" == "image" %}
                  <div class="message-media-container" onclick="openImageModal('{{ message.file.url }}', '{{ message.sender.username }}', '{{ message.timestamp|date:"M j, Y" }}')">
                    <img src="{{ message.file.url }}" alt="Shared image">
                  </div>
                {% elif message.file_type|slice:":5" == "video" %}
                  <div class="message-media-container">
                    <video controls>
                      <source src="{{ message.file.url }}" type="{{ message.file_type }}">
                      Your browser does not support the video tag.
                    </video>
                  </div>
                {% else %}
                  <!-- For other file types, show download option -->
                  <div class="message-file-container">
                    <i class="material-icons file-icon">description</i>
                    <span>{{ message.file_name }}</span>
                    <a href="{{ message.file.url }}" download="{{ message.file_name }}" class="file-download-btn">
                      Download File
                    </a>
                  </div>
                {% endif %}
                
                {% if message.content and message.content != "say something.." %}
                  <div style="margin-top: 8px;">{{ message.content|safe }}</div>
                {% endif %}
              {% else %}
                {{ message.content|safe }}
              {% endif %}
            </div>
            
            <div class="message-info">
              <span class="message-time">{{ message.timestamp|time:"H:i" }}</span>
            </div>
          </div>
        </div>
      {% endif %}
    {% endfor %}
  </div>
  
  <!-- Success Message -->
  <div id="successMessage"></div>

    <!-- Emoji Picker -->
  <emoji-picker id="emojiPicker"></emoji-picker>
  
  <!-- Message Input Area -->
  <form id="chatForm" method="post" enctype="multipart/form-data" class="message-input-area">
    {% csrf_token %}
    
    <!-- File upload button -->
    <button class="send-button" style="background: transparent; color: #666;" id="fileButton" type="button">
      <i class="material-icons">attach_file</i>
    </button>
    <input type="file" id="fileInput" name="file" style="display: none;" accept="image/*,video/*,.pdf,.doc,.docx,.txt">
    
    <!-- Emoji button -->
    <button class="send-button" style="background: transparent; color: #666;" id="emojiButton" type="button">
      <i class="material-icons">insert_emoticon</i>
    </button>
    
    <!-- Message input -->
    <div style="flex: 1; display: flex;">
      <textarea class="message-input" id="messageInput" name="content" placeholder="Type a message..." rows="1"></textarea>
    </div>
    
    <!-- Send button -->
    <button type="button" class="send-button" id="sendButton">
      <i class="material-icons">send</i>
    </button>
  </form>
</div>
<style>
  .file-preview {
    background: rgba(0, 0, 0, 0.03) !important;
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
    border-radius: 8px !important;
    padding: 10px !important;
    margin: 10px 16px !important;
  }
  
  .dark-mode .file-preview {
    background: rgba(255, 255, 255, 0.05) !important;
    border-color: rgba(255, 255, 255, 0.1) !important;
  }
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
// Add emoji picker functionality
document.addEventListener('DOMContentLoaded', function() {
  const picker = document.getElementById('emojiPicker');
  const button = document.getElementById('emojiButton');
  const input = document.getElementById('messageInput');
  
  // Toggle emoji picker visibility
  button.addEventListener('click', (e) => {
    e.preventDefault();
    if (picker.style.display === 'block') {
      picker.style.display = 'none';
    } else {
      picker.style.display = 'block';
      // Hide when clicking outside
      setTimeout(() => {
        document.addEventListener('click', hidePickerOnClickOutside);
      }, 10);
    }
  });
  
  // Insert emoji when selected
  picker.addEventListener('emoji-click', event => {
    const emoji = event.detail.unicode;
    // Insert at cursor position
    const cursorPos = input.selectionStart;
    const textBefore = input.value.substring(0, cursorPos);
    const textAfter = input.value.substring(cursorPos);
    
    input.value = textBefore + emoji + textAfter;
    
    // Set cursor position after the inserted emoji
    input.selectionStart = cursorPos + emoji.length;
    input.selectionEnd = cursorPos + emoji.length;
    
    // Trigger input event for auto-resize
    input.dispatchEvent(new Event('input'));
    
    // Focus back on input
    input.focus();
    
    // Hide picker after selection
    picker.style.display = 'none';
    document.removeEventListener('click', hidePickerOnClickOutside);
  });
  
  // Hide picker when clicking outside
  function hidePickerOnClickOutside(event) {
    if (!picker.contains(event.target) && event.target !== button) {
      picker.style.display = 'none';
      document.removeEventListener('click', hidePickerOnClickOutside);
    }
  }
  
  // Hide picker when pressing Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && picker.style.display === 'block') {
      picker.style.display = 'none';
      document.removeEventListener('click', hidePickerOnClickOutside);
      input.focus();
    }
  });
  
  // Hide picker when scrolling (on mobile)
  window.addEventListener('scroll', function() {
    if (picker.style.display === 'block') {
      picker.style.display = 'none';
      document.removeEventListener('click', hidePickerOnClickOutside);
    }
  }, true);
});



// Image modal functionality
function openImageModal(imageSrc, sender, timestamp) {
  const modal = document.getElementById("imageModal");
  const modalImg = document.getElementById("modalImage");
  const captionText = document.getElementById("modalCaption");
  const downloadBtn = document.getElementById("downloadImageBtn");
  
  modal.classList.add("show");
  modalImg.src = imageSrc;
  downloadBtn.href = imageSrc;
  
  // Set caption with sender and timestamp
  captionText.innerHTML = `Sent by ${sender} on ${timestamp}`;
  
  // Prevent background scrolling when modal is open
  document.body.style.overflow = "hidden";
}

function closeImageModal() {
  const modal = document.getElementById("imageModal");
  modal.classList.remove("show");
  
  // Re-enable background scrolling
  document.body.style.overflow = "auto";
}

// Close modal when clicking on close button or outside the image
document.getElementById("imageModal").addEventListener("click", function(e) {
  if (e.target === this || e.target.classList.contains("close-modal")) {
    closeImageModal();
  }
});

// Close modal with Escape key
document.addEventListener("keydown", function(e) {
  if (e.key === "Escape") {
    closeImageModal();
  }
});

$(document).ready(function() {
  // Initialize relative time display for all existing messages
  updateAllMessageTimes();
  
  // Auto-scroll to bottom
  scrollToBottom();

  // Variables to track file selection
  var selectedFile = null;
  var filePreviewElement = null;

  // Toggle sections
  $('#showParticipants').click(function(e) {
    e.preventDefault();
    $('#participantsSection').slideToggle();
    $('#managementSection').slideUp();
    scrollToBottom();
  });

  $('#showManagement').click(function(e) {
    e.preventDefault();
    $('#managementSection').slideToggle();
    $('#participantsSection').slideUp();
    scrollToBottom();
  });

  // Unified send function
  $('#sendButton').click(sendMessage);
  
  // Enter key handling
  $('#messageInput').keypress(function(e) {
    if (e.which == 13 && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Auto-resize textarea
  $('#messageInput').on('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
  });

  // File upload handling
  $('#fileButton').click(function() {
    $('#fileInput').click();
  });
  
  $('#fileInput').change(function() {
    if (this.files && this.files[0]) {
      const file = this.files[0];
      
      // Validate file type
      const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'video/mp4', 'video/webm', 'video/ogg', 'application/pdf', 
                           'text/plain', 'application/msword', 
                           'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
      
      if (!allowedTypes.includes(file.type)) {
        alert('File type not allowed. Please upload images, videos, PDFs, or text documents.');
        $(this).val('');
        return;
      }
      
      // Check file size (10MB limit)
      const maxSize = 10 * 1024 * 1024;
      if (file.size > maxSize) {
        alert('File size too large. Maximum size is 10MB.');
        $(this).val('');
        return;
      }
      
      selectedFile = file;
      showFilePreview(selectedFile);
    }
  });

  // File preview functions
  function showFilePreview(file) {
    removeFilePreview();
    
    filePreviewElement = $('<div>').addClass('file-preview');
    
    var previewContent = $('<div>').css({
      'display': 'flex',
      'align-items': 'center',
      'gap': '10px'
    });
    
    var fileIcon = $('<i>').addClass('material-icons').text('insert_drive_file');
    
    var fileInfo = $('<div>');
    var fileName = $('<div>').text(file.name).css({
      'font-weight': 'bold',
      'font-size': '14px'
    });
    
    var fileSize = $('<div>').text(formatFileSize(file.size)).css({
      'font-size': '12px',
      'color': '#666'
    });
    
    var cancelButton = $('<button>').html('<i class="material-icons">close</i>').css({
      'background': 'transparent',
      'border': 'none',
      'cursor': 'pointer',
      'color': '#666',
      'padding': '5px',
      'margin-left': '10px'
    }).click(function() {
      removeFilePreview();
      $('#fileInput').val('');
    });
    
    fileInfo.append(fileName, fileSize);
    previewContent.append(fileIcon, fileInfo, cancelButton);
    filePreviewElement.append(previewContent);
    
    // Image preview
    if (file.type.startsWith('image/')) {
      var reader = new FileReader();
      reader.onload = function(e) {
        var imgPreview = $('<img>').attr('src', e.target.result).css({
          'max-width': '60px',
          'max-height': '60px',
          'border-radius': '4px',
          'object-fit': 'cover'
        });
        previewContent.prepend(imgPreview);
      };
      reader.readAsDataURL(file);
    }
    
    $('.message-input-area').before(filePreviewElement);
    $('#sendButton').html('<i class="material-icons">file_upload</i>');
  }

  function removeFilePreview() {
    if (filePreviewElement) {
      filePreviewElement.remove();
      filePreviewElement = null;
    }
    selectedFile = null;
    $('#sendButton').html('<i class="material-icons">send</i>');
  }

  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  function sendMessage() {
    var form = document.getElementById("chatForm");
    var formData = new FormData(form);

    var content = $("#messageInput").val().trim();
    var file = $("#fileInput")[0].files[0];
    var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

    // Append CSRF token explicitly
    formData.append('csrfmiddlewaretoken', csrfToken);

    // Show loading state
    var sendButton = $('#sendButton');
    var originalHtml = sendButton.html();
    sendButton.html('<span class="spinner"></span>');
    sendButton.prop('disabled', true);

    $.ajax({
      url: '{% url "send_message" chat.id %}',
      type: 'POST',
      data: formData,
      processData: false,
      contentType: false,
      success: function(data) {
        handleMessageResponse(data);
        $("#messageInput").val(""); // clear text
        removeFilePreview(); // This will handle clearing the preview
        $('#fileInput').val(''); // Clear the file input after successful send
      },
      error: function(xhr) {
        handleMessageError(xhr);
        // Restore button state on error
        sendButton.html(originalHtml);
        sendButton.prop('disabled', false);
      },
      complete: function() {
        // Restore button state when complete
        sendButton.html(originalHtml);
        sendButton.prop('disabled', false);
      }
    });
  }

  // Handle successful message response
  function handleMessageResponse(data) {
    if (data.success) {
      $('#messageInput').val('');
      $('#messageInput').css('height', 'auto');
      $('#successMessage').text("Message sent successfully!").fadeIn().delay(2000).fadeOut();
      addMessageToChat(data.message);
      scrollToBottom();
    } else {
      $('#successMessage').text("Error: " + (data.error || "Unknown error")).fadeIn().delay(3000).fadeOut();
      console.error('Server error:', data.error);
    }
  }

  // Handle message error
  function handleMessageError(xhr, status, error) {
    var errorMsg = "Error sending message: ";
    if (xhr.responseJSON && xhr.responseJSON.error) {
      errorMsg += xhr.responseJSON.error;
    } else if (xhr.responseText) {
      errorMsg += xhr.responseText;
    } else {
      errorMsg += error;
    }
    $('#successMessage').text(errorMsg).fadeIn().delay(3000).fadeOut();
    console.error('AJAX error:', error, xhr.responseText);
  }

  function addMessageToChat(messageData) {
    // Check if message already exists
    if ($('#message-' + messageData.id).length) {
        return;
    }

    // Get the message date with validation
    var messageDate;
    var formattedDate;
    
    try {
        messageDate = new Date(messageData.timestamp);
        
        // Check if date is valid
        if (isNaN(messageDate.getTime())) {
            console.warn('Invalid timestamp:', messageData.timestamp);
            // Use current date as fallback
            messageDate = new Date();
        }
        
        formattedDate = formatDate(messageDate);
    } catch (error) {
        console.error('Date parsing error:', error);
        messageDate = new Date();
        formattedDate = formatDate(messageDate);
    }
    
    // Check if we need to add a date divider
    var lastDateDivider = $('.date-divider').last();
    var lastDate = lastDateDivider.length ? lastDateDivider.find('span').text() : '';
    
    if (lastDate !== formattedDate) {
        var dateDividerHtml = `
            <div class="date-divider">
                <span>${formattedDate}</span>
            </div>
        `;
        $('#messagesContainer').append(dateDividerHtml);
    }

    // Store the original timestamp in data attribute for future updates
    var timestampAttr = messageDate.getTime();
    
    var messageContent;
    
    if (messageData.file_url) {
        // Handle image files
        if (messageData.file_type && messageData.file_type.startsWith('image/')) {
            messageContent = `
                <div class="message-media-container" onclick="openImageModal('${messageData.file_url}', '${messageData.sender}', '${formatDate(messageDate)}')">
                    <img src="${messageData.file_url}" alt="Shared image">
                </div>
            `;
        } 
        // Handle video files
        else if (messageData.file_type && messageData.file_type.startsWith('video/')) {
            messageContent = `
                <div class="message-media-container">
                    <video controls>
                        <source src="${messageData.file_url}" type="${messageData.file_type}">
                        Your browser does not support the video tag.
                    </video>
                </div>
            `;
        } 
        // Handle other file types with download option
        else {
            messageContent = `
                <div class="message-file-container">
                    <i class="material-icons file-icon">description</i>
                    <span>${messageData.file_name}</span>
                    <a href="${messageData.file_url}" download="${messageData.file_name}" class="file-download-btn">
                        Download File
                    </a>
                </div>
            `;
        }
        
        // Add text content if available
        if (messageData.content && messageData.content !== "say something..") {
            messageContent += `<div style="margin-top: 8px;">${messageData.content}</div>`;
        }
    } else {
        messageContent = `<div class="message-text">${messageData.content}</div>`;
    }
    
    var messageHtml = `
        <div class="message-container ${messageData.is_own ? 'own-message-container' : 'other-message-container'}">
            ${!messageData.is_own ? `<img src="${messageData.sender_image}" class="message-profile-pic" alt="${messageData.sender}">` : ''}
            <div class="message ${messageData.is_own ? 'own-message' : 'other-message'}" id="message-${messageData.id}" data-timestamp="${timestampAttr}">
                ${!messageData.is_own ? `<div class="sender-name">~ ${messageData.sender}</div>` : ''}
                ${messageContent}
                <div class="message-info">
                    <span class="message-time">${getRelativeTime(messageDate)}</span>
                    ${messageData.is_own ? `<span class="message-status"><i class="material-icons" style="font-size:14px;">done_all</i></span>` : ''}
                </div>
            </div>
        </div>
    `;
    
    $('#messagesContainer').append(messageHtml);
    
    // Add animation for new messages
    $('#message-' + messageData.id).hide().fadeIn(300);
    
    // Start the updater if not already running
    startTimeUpdater();
  }

  function formatDate(date) {
    if (isNaN(date.getTime())) {
        date = new Date();
    }
    
    var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                  'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return months[date.getMonth()] + ' ' + date.getDate() + ', ' + date.getFullYear();
  }

  function getRelativeTime(date) {
    if (isNaN(date.getTime())) {
        return 'Just now';
    }
    
    const now = new Date();
    const diffInSeconds = Math.floor((now - date) / 1000);
    
    if (diffInSeconds < 10) {
        return 'Just now';
    }
    
    if (diffInSeconds < 60) {
        return `${diffInSeconds} sec ago`;
    }
    
    const diffInMinutes = Math.floor(diffInSeconds / 60);
    if (diffInMinutes < 60) {
        return `${diffInMinutes} min ago`;
    }
    
    const diffInHours = Math.floor(diffInMinutes / 60);
    if (diffInHours < 24) {
        return `${diffInHours} hour${diffInHours !== 1 ? 's' : ''} ago`;
    }
    
    const diffInDays = Math.floor(diffInHours / 24);
    if (diffInDays < 7) {
        return `${diffInDays} day${diffInDays !== 1 ? 's' : ''} ago`;
    }
    
    const diffInWeeks = Math.floor(diffInDays / 7);
    if (diffInWeeks < 4) {
        return `${diffInWeeks} week${diffInWeeks !== 1 ? 's' : ''} ago`;
    }
    
    // If older than a month, show the actual date
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                   'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return `${months[date.getMonth()]} ${date.getDate()}`;
  }

  // Update all message times on page load
  function updateAllMessageTimes() {
    $('.message').each(function() {
      const timestamp = $(this).data('timestamp');
      if (timestamp) {
        const messageDate = new Date(parseInt(timestamp));
        const timeElement = $(this).find('.message-time');
        if (timeElement.length) {
          timeElement.text(getRelativeTime(messageDate));
        }
      }
    });
  }

  // Time updater functionality
  let timeUpdaterInterval = null;

  function startTimeUpdater() {
      if (timeUpdaterInterval) return;
      
      timeUpdaterInterval = setInterval(updateMessageTimes, 30000); // Update every 30 seconds
  }

  function updateMessageTimes() {
      $('.message').each(function() {
          const timestamp = $(this).data('timestamp');
          if (timestamp) {
              const messageDate = new Date(parseInt(timestamp));
              const timeElement = $(this).find('.message-time');
              if (timeElement.length) {
                  timeElement.text(getRelativeTime(messageDate));
              }
          }
      });
  }

  // Stop updater when needed (optional)
  function stopTimeUpdater() {
      if (timeUpdaterInterval) {
          clearInterval(timeUpdaterInterval);
          timeUpdaterInterval = null;
      }
  }

  // Also update times when the page becomes visible again
  document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
          updateMessageTimes();
      }
  });

  function scrollToBottom() {
    var container = $('#messagesContainer');
    container.scrollTop = container[0].scrollHeight;
  }

  // Poll for new messages
  function pollForNewMessages() {
    var lastMessageId = $('.message').last().attr('id') || '0';
    lastMessageId = lastMessageId.replace('message-', '');
    
    if (lastMessageId === '0') return;

    $.ajax({
      url: window.location.href,
      type: 'GET',
      data: { last_message: lastMessageId },
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      },
      success: function(data) {
        if (data.messages && data.messages.length > 0) {
          data.messages.forEach(function(message) {
            addMessageToChat(message);
          });
          scrollToBottom();
        }
      },
      error: function(xhr) {
        console.error('Polling error:', xhr.responseText);
      }
    });
  }

  // Management form handling
  $('#addParticipantsForm, #removeParticipantsForm, #deleteChatForm').submit(function(e) {
    e.preventDefault();
    var form = $(this);
    var button = form.find('button[type="submit"]');
    var originalText = button.html();
    
    button.html('<span class="spinner"></span> ' + originalText);
    button.prop('disabled', true);

    $.ajax({
      url: form.attr('action'),
      type: 'POST',
      data: form.serialize(),
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      },
      success: function(data) {
        if (data.redirect) {
          window.location.href = data.redirect;
        } else {
          location.reload();
        }
      },
      error: function(xhr) {
        alert('An error occurred: ' + xhr.responseText);
        button.html(originalText);
        button.prop('disabled', false);
      }
    });
  });

  // Start polling for new messages
  setInterval(pollForNewMessages, 3000);
});
</script>
{% endblock %}