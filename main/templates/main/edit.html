{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free GIF Creator</title>
    <style>
        :root {
            --primary: #6c5ce7;
            --secondary: #a29bfe;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #00b894;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #000000;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .gif-creator {
            background-color: #222222;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 450px;
            padding: 25px;
            transition: all 0.3s ease;
            color: #ffffff;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            color: var(--primary);
            font-size: 26px;
            margin-bottom: 5px;
        }

        .header p {
            color: #cccccc;
            font-size: 14px;
            opacity: 0.7;
        }

        .upload-area {
            border: 2px dashed var(--secondary);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            background-color: rgba(162, 155, 254, 0.05);
        }

        .upload-area:hover {
            background-color: 'rgba(162, 155, 254, 0.1)';
            border-color: 'var(--primary)';
        }

        .upload-area i {
            font-size: 40px;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .upload-area p {
            color: #cccccc;
            font-size: 14px;
        }

        .upload-area input {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .controls {
            margin-bottom: 20px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            color: #cccccc;
            font-size: 14px;
            font-weight: 500;
        }

        .control-group input[type="range"] {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: #444444;
            border-radius: 5px;
            outline: none;
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }

        .control-group select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            background-color: #333333;
            color: white;
            border: 1px solid #555555;
            font-size: 14px;
        }

        .preview-container {
            position: relative;
            margin-bottom: 20px;
            display: none;
            text-align: center;
        }

        .canvas-container {
            width: 100%;
            height: 250px;
            border-radius: 10px;
            border: 1px solid #444444;
            overflow: hidden;
            background: #111111;
            margin: 0 auto;
            position: relative;
        }

        #gifCanvas {
            display: block;
            max-width: 100%;
            max-height: 100%;
            margin: 0 auto;
            object-fit: contain;
        }

        .frames-container {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
            margin-bottom: 20px;
            min-height: 80px;
        }

        .frame {
            width: 70px;
            height: 70px;
            border-radius: 5px;
            border: 2px solid #444444;
            object-fit: cover;
            flex-shrink: 0;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: #333333;
        }

        .frame:hover {
            transform: scale(1.05);
            border-color: var(--primary);
        }

        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            background-color: #5649d1;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn i {
            font-size: 16px;
        }

        .btn-secondary {
            background-color: #333333;
            color: #ffffff;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background-color: #444444;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 10px 0;
            color: #cccccc;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            display: inline-block;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .download-link {
            display: none;
            text-align: center;
            margin-top: 15px;
        }

        .download-link a {
            color: var(--success);
            text-decoration: none;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .download-link a:hover {
            text-decoration: underline;
        }

        .quality-info {
            font-size: 12px;
            color: #aaa;
            margin-top: 5px;
        }

        /* Simple Editor Styles */
        .editor-section {
            margin-top: 20px;
            border-top: 1px solid #444;
            padding-top: 20px;
            display: none;
        }

        .editor-section h3 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .editor-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .editor-btn {
            background-color: #333;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .editor-btn:hover {
            background-color: var(--primary);
        }

        .editor-btn i {
            font-size: 14px;
        }

        .filter-controls {
            display: none;
            margin-top: 15px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .filter-slider {
            margin-bottom: 10px;
        }

        .filter-slider label {
            display: flex;
            justify-content: space-between;
            color: #ccc;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .filter-slider input {
            width: 100%;
        }

        .rotate-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .rotate-btn {
            flex: 1;
            padding: 8px;
            background: #333;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .rotate-btn i {
            font-size: 14px;
        }

        .rotate-btn:hover {
            background: var(--primary);
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            body {
                padding: 0;
                display: block;
            }

            .gif-creator {
                max-width: 100%;
                border-radius: 0;
                min-height: 100vh;
                padding: 15px;
            }

            .upload-area {
                padding: 20px 15px;
            }

            .btn {
                padding: 10px 15px;
                font-size: 13px;
            }

            .header h1 {
                font-size: 22px;
            }

            .frames-container {
                padding-left: 5px;
                padding-right: 5px;
            }

            .editor-controls {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .gif-creator {
                padding: 10px;
            }

            .upload-area {
                padding: 15px 10px;
            }

            .frame {
                width: 60px;
                height: 60px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="gif-creator">
        <div class="header">
            <h1>Free GIF Creator</h1>
            <p>Create simple GIFs from your images</p>
        </div>

        <div class="upload-area" id="uploadArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Click to upload images or drag & drop</p>
            <p><small>Supports JPG, PNG, GIF (Max 10MB)</small></p>
            <input type="file" id="fileInput" accept="image/*" multiple>
        </div>

        <div class="preview-container" id="previewContainer">
            <div class="canvas-container">
                <canvas id="gifCanvas"></canvas>
            </div>
        </div>

        <div class="frames-container" id="framesContainer"></div>

        <!-- Simple Editor Section -->
        <div class="editor-section" id="editorSection">
            <h3><i class="fas fa-sliders-h"></i> Basic Editor</h3>
            
            <div class="editor-controls">
                <button class="editor-btn" id="rotateBtn">
                    <i class="fas fa-sync-alt"></i> Rotate
                </button>
                <button class="editor-btn" id="flipBtn">
                    <i class="fas fa-arrows-alt-h"></i> Flip
                </button>
            </div>

            <!-- Rotate Controls -->
            <div class="filter-controls" id="rotateControls">
                <div class="rotate-controls">
                    <button class="rotate-btn" id="rotate90LeftBtn">
                        <i class="fas fa-undo"></i> 90° Left
                    </button>
                    <button class="rotate-btn" id="rotate90RightBtn">
                        <i class="fas fa-redo"></i> 90° Right
                    </button>
                </div>
                <div class="rotate-controls" style="margin-top: 10px;">
                    <button class="rotate-btn" id="rotate180Btn">
                        <i class="fas fa-sync-alt"></i> 180°
                    </button>
                </div>
                <button class="btn btn-secondary" id="applyRotateBtn" style="margin-top: 10px;">
                    <i class="fas fa-check"></i> Apply Rotation
                </button>
            </div>

            <!-- Flip Controls -->
            <div class="filter-controls" id="flipControls">
                <div class="rotate-controls">
                    <button class="rotate-btn" id="flipHorizontalBtn">
                        <i class="fas fa-arrows-alt-h"></i> Flip Horizontal
                    </button>
                    <button class="rotate-btn" id="flipVerticalBtn">
                        <i class="fas fa-arrows-alt-v"></i> Flip Vertical
                    </button>
                </div>
                <button class="btn btn-secondary" id="applyFlipBtn" style="margin-top: 10px;">
                    <i class="fas fa-check"></i> Apply Flip
                </button>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="speedControl">Preview Speed: <span id="speedValue">500ms (Normal)</span></label>
                <input type="range" id="speedControl" min="50" max="2000" value="500" step="50">
            </div>
            <div class="control-group">
                <label for="gifSpeedControl">GIF Speed: <span id="gifSpeedValue">5000ms (Very Slow)</span></label>
                <input type="range" id="gifSpeedControl" min="100" max="20000" value="5000" step="100">
            </div>
            <div class="control-group">
                <label for="sizeControl">Output Size: <span id="sizeValue">300</span>px</label>
                <input type="range" id="sizeControl" min="100" max="1000" value="300" step="50">
                <div class="quality-info">Max size limited to 1000px in free version</div>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Creating your GIF...</p>
        </div>

        <button class="btn" id="createGifBtn" disabled>
            <i class="fas fa-magic"></i> Create GIF
        </button>
        <button class="btn btn-secondary" id="resetBtn">
            <i class="fas fa-redo"></i> Reset
        </button>

        <div class="download-link" id="downloadLink">
            <a href="#" id="downloadAnchor"><i class="fas fa-download"></i> Download GIF</a>
        </div>


<a href="{% url 'poster_canva' %}" style="
    display: block;
    text-align: center;
    margin-top: 15px;
    padding: 8px 15px;
    background-color: #00b894;
    color: white;
    border-radius: 8px;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
">
    <i class="fas fa-paint-brush"></i> Try Premium Creator
</a>

    </div>

    <!-- Load local GIF library -->
    <script src="{% static 'main/js/gif.js' %}"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM Elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const gifCanvas = document.getElementById('gifCanvas');
        const ctx = gifCanvas.getContext('2d', { willReadFrequently: true });
        const framesContainer = document.getElementById('framesContainer');
        const speedControl = document.getElementById('speedControl');
        const speedValue = document.getElementById('speedValue');
        const gifSpeedControl = document.getElementById('gifSpeedControl');
        const gifSpeedValue = document.getElementById('gifSpeedValue');
        const sizeControl = document.getElementById('sizeControl');
        const sizeValue = document.getElementById('sizeValue');
        const createGifBtn = document.getElementById('createGifBtn');
        const resetBtn = document.getElementById('resetBtn');
        const loading = document.getElementById('loading');
        const downloadLink = document.getElementById('downloadLink');
        const downloadAnchor = document.getElementById('downloadAnchor');
        
        // Editor Elements
        const editorSection = document.getElementById('editorSection');
        const rotateBtn = document.getElementById('rotateBtn');
        const flipBtn = document.getElementById('flipBtn');
        const rotateControls = document.getElementById('rotateControls');
        const flipControls = document.getElementById('flipControls');
        const rotate90LeftBtn = document.getElementById('rotate90LeftBtn');
        const rotate90RightBtn = document.getElementById('rotate90RightBtn');
        const rotate180Btn = document.getElementById('rotate180Btn');
        const flipHorizontalBtn = document.getElementById('flipHorizontalBtn');
        const flipVerticalBtn = document.getElementById('flipVerticalBtn');
        const applyRotateBtn = document.getElementById('applyRotateBtn');
        const applyFlipBtn = document.getElementById('applyFlipBtn');

        // Variables
        let images = [];
        let originalImages = [];
        let animationInterval = null;
        let currentDownloadUrl = null;
        let currentRotation = 0;
        let isFlippedHorizontal = false;
        let isFlippedVertical = false;

        // Event Listeners
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.backgroundColor = 'rgba(162, 155, 254, 0.2)';
            uploadArea.style.borderColor = 'var(--primary)';
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.backgroundColor = 'rgba(162, 155, 254, 0.05)';
            uploadArea.style.borderColor = 'var(--secondary)';
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.backgroundColor = 'rgba(162, 155, 254, 0.05)';
            uploadArea.style.borderColor = 'var(--secondary)';
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', () => handleFiles(fileInput.files));
        speedControl.addEventListener('input', updateSpeedValue);
        gifSpeedControl.addEventListener('input', updateGifSpeedValue);
        sizeControl.addEventListener('input', updateSizeValue);
        createGifBtn.addEventListener('click', createGif);
        resetBtn.addEventListener('click', resetAll);
        
        // Editor Event Listeners
        rotateBtn.addEventListener('click', () => showEditorControls('rotate'));
        flipBtn.addEventListener('click', () => showEditorControls('flip'));
        rotate90LeftBtn.addEventListener('click', () => rotateImage(-90));
        rotate90RightBtn.addEventListener('click', () => rotateImage(90));
        rotate180Btn.addEventListener('click', () => rotateImage(180));
        flipHorizontalBtn.addEventListener('click', () => flipImage('horizontal'));
        flipVerticalBtn.addEventListener('click', () => flipImage('vertical'));
        applyRotateBtn.addEventListener('click', applyRotation);
        applyFlipBtn.addEventListener('click', applyFlip);

        // Initial setup
        updateSpeedValue();
        updateGifSpeedValue();
        updateSizeValue();
        downloadLink.style.display = 'none';
        hideAllEditorControls();

        // Functions
        function showEditorControls(type) {
            hideAllEditorControls();
            
            if (type === 'rotate') {
                rotateControls.style.display = 'block';
            } else if (type === 'flip') {
                flipControls.style.display = 'block';
            }
            
            if (images.length > 0) {
                const selectedFrame = framesContainer.querySelector('.frame[style*="border-color"]');
                if (selectedFrame) {
                    const img = new Image();
                    img.src = selectedFrame.src;
                    img.onload = () => drawImageToCanvas(img);
                }
            }
        }

        function hideAllEditorControls() {
            rotateControls.style.display = 'none';
            flipControls.style.display = 'none';
        }

        function rotateImage(degrees) {
            currentRotation += degrees;
            
            if (images.length === 0) return;
            
            const selectedFrame = framesContainer.querySelector('.frame[style*="border-color"]');
            if (!selectedFrame) return;
            
            const img = new Image();
            img.src = selectedFrame.src;
            img.onload = function() {
                drawImageToCanvas(img);
            };
        }

        function flipImage(direction) {
            if (direction === 'horizontal') {
                isFlippedHorizontal = !isFlippedHorizontal;
            } else if (direction === 'vertical') {
                isFlippedVertical = !isFlippedVertical;
            }
            
            if (images.length === 0) return;
            
            const selectedFrame = framesContainer.querySelector('.frame[style*="border-color"]');
            if (!selectedFrame) return;
            
            const img = new Image();
            img.src = selectedFrame.src;
            img.onload = function() {
                drawImageToCanvas(img);
            };
        }

        function applyRotation() {
            hideAllEditorControls();
            
            if (images.length === 0) return;
            
            const selectedFrame = framesContainer.querySelector('.frame[style*="border-color"]');
            if (!selectedFrame) return;
            
            const img = new Image();
            img.src = selectedFrame.src;
            img.onload = function() {
                drawImageToCanvas(img);
            };
        }

        function applyFlip() {
            hideAllEditorControls();
            
            if (images.length === 0) return;
            
            const selectedFrame = framesContainer.querySelector('.frame[style*="border-color"]');
            if (!selectedFrame) return;
            
            const img = new Image();
            img.src = selectedFrame.src;
            img.onload = function() {
                drawImageToCanvas(img);
            };
        }

        function applyImageEffects(image, size) {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = size;
            tempCanvas.height = size;
            const tempCtx = tempCanvas.getContext('2d');
            
            // Apply rotation and flip
            tempCtx.save();
            tempCtx.translate(size / 2, size / 2);
            tempCtx.rotate(currentRotation * Math.PI / 180);
            
            if (isFlippedHorizontal) {
                tempCtx.scale(-1, 1);
            }
            
            if (isFlippedVertical) {
                tempCtx.scale(1, -1);
            }
            
            const ratio = Math.min(size / image.width, size / image.height);
            const width = image.width * ratio;
            const height = image.height * ratio;
            const x = -width / 2;
            const y = -height / 2;
            
            // Always use black background
            tempCtx.fillStyle = '#000000';
            tempCtx.fillRect(-size / 2, -size / 2, size, size);
            
            tempCtx.drawImage(image, x, y, width, height);
            tempCtx.restore();
            
            return tempCanvas;
        }

        function updateSpeedValue() {
            const speed = parseInt(speedControl.value);
            let speedDescription = "";
            
            if (speed < 200) speedDescription = " (Very Fast)";
            else if (speed < 400) speedDescription = " (Fast)";
            else if (speed < 700) speedDescription = " (Normal)";
            else if (speed < 1000) speedDescription = " (Slow)";
            else speedDescription = " (Very Slow)";
            
            speedValue.textContent = speed + "ms" + speedDescription;
            
            if (animationInterval) {
                clearInterval(animationInterval);
                startAnimation();
            }
        }

        function updateGifSpeedValue() {
            const speed = parseInt(gifSpeedControl.value);
            let speedDescription = "";
            
            if (speed < 500) speedDescription = " (Fast)";
            else if (speed < 1000) speedDescription = " (Normal)";
            else if (speed < 3000) speedDescription = " (Slow)";
            else if (speed < 8000) speedDescription = " (Very Slow)";
            else speedDescription = " (Extremely Slow)";
            
            gifSpeedValue.textContent = speed + "ms" + speedDescription;
        }

        function updateSizeValue() {
            sizeValue.textContent = sizeControl.value;
            if (images.length > 0) {
                if (animationInterval) {
                    drawImageToCanvas(images[0]);
                } else if (framesContainer.querySelector('.frame')) {
                    const selectedFrame = framesContainer.querySelector('.frame[style*="border-color"]');
                    if (selectedFrame) {
                        const img = new Image();
                        img.src = selectedFrame.src;
                        img.onload = () => drawImageToCanvas(img);
                    }
                }
            }
        }

        function updateCreateButton() {
            createGifBtn.disabled = images.length < 2;
        }

        function handleFiles(files) {
            if (files.length === 0) return;
            
            if (animationInterval) {
                clearInterval(animationInterval);
                animationInterval = null;
            }
            
            images = [];
            originalImages = [];
            framesContainer.innerHTML = '';
            
            Array.from(files).forEach(file => {
                if (!file.type.match('image.*')) return;
                
                // Limit file size to 10MB in free version
                if (file.size > 10 * 1024 * 1024) {
                    alert('File size exceeds 10MB limit in free version: ' + file.name);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        images.push(img);
                        originalImages.push({
                            src: e.target.result,
                            file: file,
                            name: file.name
                        });
                        addFrameToContainer(img);
                        updateCreateButton();
                        
                        // Show editor section when first image is loaded
                        if (images.length === 1) {
                            editorSection.style.display = 'block';
                        }
                    };
                };
                reader.readAsDataURL(file);
            });
        }

        function addFrameToContainer(img) {
            const frame = document.createElement('img');
            frame.className = 'frame';
            frame.src = img.src;
            frame.addEventListener('click', () => {
                document.querySelectorAll('.frame').forEach(f => f.style.borderColor = '#444444');
                frame.style.borderColor = 'var(--primary)';
                drawImageToCanvas(img);
                previewContainer.style.display = 'block';
            });
            framesContainer.appendChild(frame);
            
            // Select the first frame by default
            if (framesContainer.children.length === 1) {
                frame.style.borderColor = 'var(--primary)';
                drawImageToCanvas(img);
                previewContainer.style.display = 'block';
            }
        }

        function drawImageToCanvas(img) {
            const size = parseInt(sizeControl.value);
            gifCanvas.width = size;
            gifCanvas.height = size;
            
            // Apply all image effects
            const processedCanvas = applyImageEffects(img, size);
            ctx.clearRect(0, 0, gifCanvas.width, gifCanvas.height);
            
            // Always use black background
            ctx.fillStyle = '#111111';
            ctx.fillRect(0, 0, gifCanvas.width, gifCanvas.height);
            
            ctx.drawImage(processedCanvas, 0, 0);
        }

        function startAnimation() {
            const delay = parseInt(speedControl.value);
            let currentIndex = 0;
            
            if (images.length > 0) {
                drawImageToCanvas(images[0]);
                previewContainer.style.display = 'block';
            }
            
            animationInterval = setInterval(() => {
                currentIndex = (currentIndex + 1) % images.length;
                drawImageToCanvas(images[currentIndex]);
            }, delay);
        }

        function createGif() {
            if (images.length < 2) return;
            
            loading.style.display = 'block';
            createGifBtn.disabled = true;
            downloadLink.style.display = 'none';
            
            if (animationInterval) {
                clearInterval(animationInterval);
                animationInterval = null;
            }
            
            const size = parseInt(sizeControl.value);
            const gifDelay = parseInt(gifSpeedControl.value);
            
            // Limit size to 1000px in free version
            const finalSize = Math.min(size, 1000);
            
            const gif = new GIF({
                workers: 2,
                quality: 10,
                width: finalSize,
                height: finalSize,
                workerScript: "{% static 'main/js/gif.worker.js' %}",
                repeat: 0,
                background: '#000000',
                dither: 'FloydSteinberg-serpentine',
                optimize: true,
                maxWorkers: 2
            });
            
            images.forEach(img => {
                const enhancedCanvas = applyImageEffects(img, finalSize);
                const frameCanvas = document.createElement('canvas');
                frameCanvas.width = finalSize;
                frameCanvas.height = finalSize;
                const frameCtx = frameCanvas.getContext('2d');
                
                frameCtx.fillStyle = '#000000';
                frameCtx.fillRect(0, 0, finalSize, finalSize);
                frameCtx.drawImage(enhancedCanvas, 0, 0);
                
                gif.addFrame(frameCanvas, {
                    delay: Math.max(1, Math.round(gifDelay / 10)),
                    copy: true,
                    dispose: 1
                });
            });
            
            gif.on('finished', function(blob) {
                loading.style.display = 'none';
                createGifBtn.disabled = false;
                
                if (currentDownloadUrl) {
                    URL.revokeObjectURL(currentDownloadUrl);
                }
                
                currentDownloadUrl = URL.createObjectURL(blob);
                
                downloadAnchor.href = currentDownloadUrl;
                downloadAnchor.download = `simple-gif-${Date.now()}.gif`;
                
                downloadLink.style.display = 'block';
                
                const previewImg = new Image();
                previewImg.src = currentDownloadUrl;
                previewImg.onload = () => {
                    drawImageToCanvas(previewImg);
                    previewContainer.style.display = 'block';
                };
            });

            gif.on('error', function(error) {
                loading.style.display = 'none';
                createGifBtn.disabled = false;
                console.error('GIF creation error:', error);
                alert("Error creating GIF: " + error.message);
            });
            
            gif.render();
        }

        function resetAll() {
            if (animationInterval) {
                clearInterval(animationInterval);
                animationInterval = null;
            }
            
            ctx.clearRect(0, 0, gifCanvas.width, gifCanvas.height);
            images = [];
            originalImages = [];
            framesContainer.innerHTML = '';
            previewContainer.style.display = 'none';
            downloadLink.style.display = 'none';
            fileInput.value = '';
            createGifBtn.disabled = true;
            speedControl.value = 500;
            gifSpeedControl.value = 2000;
            updateSpeedValue();
            updateGifSpeedValue();
            sizeControl.value = 300;
            updateSizeValue();
            loading.style.display = 'none';
            
            // Reset editor settings
            currentRotation = 0;
            isFlippedHorizontal = false;
            isFlippedVertical = false;
            hideAllEditorControls();
            
            if (currentDownloadUrl) {
                URL.revokeObjectURL(currentDownloadUrl);
                currentDownloadUrl = null;
            }
        }
    });
    </script>
</body>
</html>